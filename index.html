<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>El Impostorcillo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
* {
  box-sizing: border-box;
  font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
}

body {
  margin: 0;
  background: radial-gradient(circle at top, #1f2937 0, #020617 45%, #000 100%);
  color: #f5f5f5;
  display: flex;
  justify-content: center;
  align-items: center;
  min-height: 100vh;
}

.app {
  width: 100%;
  max-width: 480px;
  padding: 16px;
}

.card {
  background: rgba(15, 23, 42, 0.95);
  border-radius: 20px;
  padding: 24px 20px 20px;
  box-shadow: 0 20px 40px rgba(0,0,0,0.6);
  position: relative;
  backdrop-filter: blur(10px);
  border: 1px solid rgba(148, 163, 184, 0.3);
}

.screen.hidden {
  display: none;
}

h1, h2, h3 {
  margin-top: 0;
  text-align: center;
}

h1 {
  font-size: 1.9rem;
  margin-bottom: 0.5rem;
}

p {
  line-height: 1.4;
}

label {
  display: block;
  margin: 10px 0 4px;
  font-size: 0.9rem;
  opacity: 0.9;
}

input,
select {
  width: 100%;
  padding: 8px 10px;
  border-radius: 8px;
  border: none;
  font-size: 1rem;
  margin-bottom: 8px;
}

/* Botones */
button {
  width: 100%;
  padding: 12px;
  border-radius: 999px;
  border: none;
  font-size: 1rem;
  font-weight: 600;
  margin-top: 14px;
  cursor: pointer;
  background: linear-gradient(135deg, #22c55e, #16a34a);
  color: #fff;
  box-shadow: 0 6px 16px rgba(22, 163, 74, 0.5);
  transition: transform 0.1s ease, box-shadow 0.1s ease, opacity 0.15s ease;
}

button.secondary {
  background: #374151;
  box-shadow: none;
}

button:active {
  transform: translateY(1px);
  box-shadow: 0 3px 8px rgba(22, 163, 74, 0.4);
  opacity: 0.9;
}

.small {
  font-size: 0.85rem;
  text-align: center;
  opacity: 0.8;
  margin-top: 12px;
}

.version-label {
  margin-top: 8px;
  font-size: 0.8rem;
  opacity: 0.7;
}

.badge {
  display: inline-block;
  padding: 4px 10px;
  border-radius: 999px;
  font-size: 0.75rem;
  text-transform: uppercase;
  letter-spacing: 0.05em;
  background: #1f2937;
  color: #9ca3af;
  margin-bottom: 10px;
}

.center {
  text-align: center;
}

.highlight {
  color: #22c55e;
  font-weight: 700;
}

/* Botón pequeño menú */
.menu-button {
  position: absolute;
  top: -14px;
  right: -14px;
  width: 32px;
  height: 32px;
  border-radius: 50%;
  border: none;
  cursor: pointer;
  background: #374151;
  color: #e5e7eb;
  font-size: 0.7rem;
  box-shadow: 0 2px 6px rgba(0,0,0,0.4);
  padding: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 10;
}

.menu-button span {
  pointer-events: none;
}

/* Inicio */
.hero-illustration {
  display: flex;
  justify-content: center;
  margin-bottom: 16px;
}

.hero-illustration img {
  width: 80%;
  max-width: 260px;
  border-radius: 24px;
  box-shadow: 0 10px 30px rgba(0,0,0,0.5);
}

/* Configuración */
.title-row {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 10px;
  margin-bottom: 4px;
}

.title-icon {
  width: 56px;
  height: 56px;
  border-radius: 50%;
  box-shadow: 0 4px 12px rgba(0,0,0,0.4);
}

/* Fila de jugador: nombre + avatar */
.player-row {
  display: flex;
  align-items: center;
  gap: 10px;
  margin-bottom: 8px;
}

.player-row input {
  flex: 1;
}

/* Avatar pequeño junto al nombre (configuración) */
.avatar-thumb {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  object-fit: cover;
  border: 2px solid rgba(148,163,184,0.8);
  cursor: pointer;
  box-shadow: 0 0 6px rgba(0,0,0,0.5);
  transition: transform 0.1s ease, box-shadow 0.1s ease, border-color 0.1s ease;
  flex-shrink: 0;
}

.avatar-thumb:hover {
  transform: scale(1.05);
  box-shadow: 0 0 10px rgba(34,197,94,0.7);
  border-color: rgba(34,197,94,0.8);
}

/* Badge del rol (fila superior en pantalla de rol) */
.role-badge-row .badge {
  background: rgba(15,23,42,0.95);
  color: #e5e7eb;
  padding: 6px 14px;
}

/* Nombre del jugador grande en pantalla de rol */
.player-name-big {
  font-size: 1.8rem;
  font-weight: 800;
  text-align: center;
  margin: 0 0 14px 0;
  color: #f8fafc;
  letter-spacing: 1px;
  text-transform: uppercase;
}

/* ==========================
   CARTA NIVEL DIOS
   ========================== */

.card-slider {
  width: 100%;
  height: 420px;
  position: relative;
  margin: 0 auto 20px auto;
  border-radius: 26px;
  overflow: hidden;
  touch-action: none;
}

/* Marco general */
.card-frame {
  width: 100%;
  height: 100%;
  position: absolute;
  inset: 0;
  background-size: contain;
  background-repeat: no-repeat;
  background-position: center;
}

/* Parte delantera (avatar + instrucciones) */
.card-front {
  position: absolute;
  inset: 0;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: flex-start;
  text-align: center;
  touch-action: none;
}

/* Marco frontal con textura cuero */
.card-front-frame {
  position: absolute;
  inset: 0;
  background-image: url("img/card-frame-front.png");
  background-size: contain;
  background-repeat: no-repeat;
  background-position: center;
  z-index: 1;
}

/* Avatar centrado */
.front-avatar-wrapper {
  margin-top: 70px; /* AJUSTE PRINCIPAL */
  width: 160px;
  height: 160px;
  z-index: 3;
}

.front-avatar-wrapper img {
  width: 100%;
  height: 100%;
  object-fit: cover;
  border-radius: 50%;
  border: 6px solid #fff4;
}

/* Texto de instrucción */
.slide-text {
  margin-top: 260px;
  font-size: 1.1rem;
  color: white;
  text-shadow: 0 2px 4px rgba(0,0,0,0.5);
  z-index: 3;
}

/* ==========================
   PARTE TRASERA DE LA CARTA
   ========================== */

.card-back {
  position: absolute;
  inset: 0;
  padding-top: 160px; 
  text-align: center;
  z-index: 2;
}

.card-back-frame {
  position: absolute;
  inset: 0;
  background-image: url("img/card-frame-back.png");
  background-size: contain;
  background-position: center;
  background-repeat: no-repeat;
  z-index: 1;
}

.card-back-content {
  z-index: 2;
  position: relative;
  padding: 20px;
}

.card-back-content h3 {
  margin: 0;
  font-size: 1.6rem;
  color: #2a1f0a;
}

.card-back-content #roleWord {
  font-size: 2rem;
  font-weight: bold;
  margin-top: 8px;
  color: #1e1a12;
}

.card-back-content .role-tip {
  margin-top: 12px;
  font-size: 1rem;
  color: #333;
}
/* Botón siguiente jugador */
#nextPlayerBtn {
  background: #3f3f46;
  color: #d4d4d8;
  opacity: 0.5;
  border-radius: 12px;
  padding: 14px 24px;
  font-size: 1.05rem;
  border: none;
  width: 90%;
  max-width: 320px;
  margin: 20px auto 0;
  display: block;
  box-shadow: none;
}

#nextPlayerBtn.active {
  background: linear-gradient(135deg, #16a34a, #22c55e);
  color: #ffffff;
  opacity: 1;
  box-shadow: 0 0 12px rgba(34,197,94,0.6);
}

/* Botón mostrar/ocultar rol en escritorio */
#toggleRoleBtn {
  width: auto;
  padding-inline: 18px;
  margin-top: 8px;
  font-size: 0.9rem;
}

/* MODAL SELECCIÓN DE AVATAR */
.avatar-modal {
  position: fixed;
  inset: 0;
  background: rgba(15, 23, 42, 0.85);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 1000;
}

.avatar-modal.hidden {
  display: none;
}

.avatar-modal-content {
  background: rgba(15, 23, 42, 0.98);
  border-radius: 20px;
  padding: 20px 16px 16px;
  width: 100%;
  max-width: 420px;
  box-shadow: 0 20px 45px rgba(0, 0, 0, 0.75);
  border: 1px solid rgba(148, 163, 184, 0.4);
}

.avatar-modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 12px;
}

.avatar-modal-title {
  font-size: 1.1rem;
  font-weight: 600;
}

.avatar-modal-close {
  background: none;
  border: none;
  color: #e5e7eb;
  font-size: 1.2rem;
  cursor: pointer;
  width: auto;
  box-shadow: none;
  padding: 0;
}

.avatar-grid {
  display: grid;
  grid-template-columns: repeat(4, minmax(0, 1fr));
  gap: 12px;
}

.avatar-option {
  background: transparent;
  border: none;
  padding: 0;
  cursor: pointer;
  border-radius: 999px;
}

.avatar-option img {
  width: 64px;
  height: 64px;
  border-radius: 50%;
  object-fit: cover;
  border: 2px solid transparent;
  box-shadow: 0 0 8px rgba(0, 0, 0, 0.6);
  transition: transform 0.12s ease, box-shadow 0.12s ease, border-color 0.12s ease;
}

.avatar-option:hover img {
  transform: translateY(-2px) scale(1.03);
  border-color: #22c55e;
  box-shadow: 0 0 12px rgba(34, 197, 94, 0.7);
}
  </style>
</head>
<body>
  <div class="app">
    <div class="card">

      <!-- botón de menú global -->
      <button class="menu-button" onclick="goToSetup()">
        <span>≡</span>
      </button>

      <!-- PANTALLA: INICIO -->
      <div id="screen-start" class="screen">
        <div class="hero-illustration">
          <img src="img/impostor-hero.png" alt="Impostorcillo">
        </div>

        <h1>El Impostorcillo</h1>

        <p class="center">
          El juego social de deducción y engaño.<br>
          ¡Intenta no parecer sospechoso!
        </p>

        <button onclick="goToSetup()">Nueva partida</button>

        <p id="appVersion" class="small version-label"></p>
      </div>

      <!-- PANTALLA: CONFIGURACIÓN -->
      <div id="screen-setup" class="screen hidden">

        <div class="title-row">
          <img src="img/impostor-icon.png" class="title-icon">
          <h2>Configuración</h2>
        </div>

        <label for="selectPlayers">Número de jugadores</label>
        <select id="selectPlayers">
          <option value="3" selected>3 jugadores</option>
          <option value="4">4 jugadores</option>
          <option value="5">5 jugadores</option>
          <option value="6">6 jugadores</option>
          <option value="7">7 jugadores</option>
          <option value="8">8 jugadores</option>
          <option value="9">9 jugadores</option>
          <option value="10">10 jugadores</option>
        </select>

        <label>Nombre y avatar de los jugadores</label>
        <div id="playerNamesContainer"></div>

        <label for="selectCategory">Categoría</label>
        <select id="selectCategory">
          <option value="aleatorio">Aleatorio</option>
          <option value="comida">Comida</option>
          <option value="animales">Animales</option>
          <option value="objetos">Objetos</option>
          <option value="sitios">Sitios</option>
          <option value="deportes">Deportes</option>
          <option value="videojuegos">Videojuegos</option>
          <option value="transportes">Transportes</option>
        </select>

        <button onclick="startGame()">Empezar</button>
        <button class="secondary" onclick="backToStart()">Volver</button>

        <p class="small">
          1 impostorcillo por ronda. Pistas orales. Deducción pura.
        </p>
      </div>

<!-- PANTALLA: ROL -->
<div id="screen-role" class="screen hidden">

  <!-- Orden del jugador -->
  <div class="role-badge-row">
    <span class="badge" id="playerOrderBadge"></span>
  </div>

  <h2 id="playerNameBig"></h2>

  <div class="card-slider">

    <!-- Parte trasera -->
    <div class="card-back">
      <div class="card-back-frame"></div>

      <div class="card-back-content">
        <h3 id="roleTitle"></h3>
        <div id="roleWord"></div>
        <p class="role-tip" id="roleTip"></p>
      </div>
    </div>

    <!-- Parte delantera (deslizable) -->
    <div class="card-front" id="cardFront">
      <div class="card-front-frame"></div>

      <div class="front-avatar-wrapper">
        <img id="frontAvatar" src="img/avatars/avatar1.png">
      </div>

      <p class="slide-text" id="instructionText">
        Desliza hacia arriba para ver tu rol<br>Suéltala para bajarla
      </p>
    </div>
  </div>

  <button id="nextPlayerBtn" class="secondary hidden">Jugador siguiente</button>
</div>
        <!-- Botón para escritorio -->
        <button id="toggleRoleBtn" class="secondary">Mostrar rol</button>

        <!-- Botón de siguiente jugador -->
        <button id="nextPlayerBtn" class="secondary hidden" onclick="nextPlayer()">
          Jugador siguiente
        </button>
      </div>

      <!-- PANTALLA: DEBATE -->
      <div id="screen-debate" class="screen hidden">
        <h2>Debatid y votad</h2>

        <p class="center">
          Todos han visto ya su rol.<br>
          Ahora toca hablar:
        </p>

        <p id="starterInfo" class="center" style="font-size:1.1rem; margin-top:10px;"></p>

        <ul style="font-size:0.95rem; line-height:1.5;">
          <li>Cada jugador dice una pista.</li>
          <li>Debatid y acusad a quien creáis sospechoso.</li>
          <li>Haced una votación final.</li>
        </ul>

        <button id="btnGoReveal">Ver resultado</button>
      </div>

      <!-- PANTALLA: REVELACIÓN -->
      <div id="screen-reveal" class="screen hidden">

        <h2>Revelación</h2>

        <p class="center">La palabra secreta era:</p>
        <div id="finalWord"
             style="font-size:1.9rem; text-align:center; margin:12px 0;">
        </div>

        <p class="center">
          El Impostorcillo era:<br>
          <span class="highlight" id="impostorPlayer"></span>
        </p>

        <button onclick="startAnotherRound()">Jugar otra ronda</button>
        <button class="secondary" onclick="backToStart()">Volver al inicio</button>
      </div>

      <!-- MODAL: SELECCIÓN AVATAR -->
      <div id="avatarModal" class="avatar-modal hidden">
        <div class="avatar-modal-content">

          <div class="avatar-modal-header">
            <div class="avatar-modal-title">Elige un avatar</div>
            <button id="avatarModalClose" class="avatar-modal-close" type="button">✕</button>
          </div>

          <p class="small" style="margin-top:0;margin-bottom:12px;">
            Toca un avatar para asignarlo al jugador.
          </p>

          <div id="avatarGrid" class="avatar-grid"></div>

        </div>
      </div>

    </div>
  </div>

<script>
const APP_VERSION = "1.1.1";
const CSV_URL = "data/words-es.csv?v=" + APP_VERSION;

// detectar táctil
const isTouch = ("ontouchstart" in window || navigator.maxTouchPoints > 0);

// avatares
const AVATAR_COUNT = 8; // pon aquí el número real de avatares que tengas

function avatarSrcFromIndex(idx) {
  const padded = String(idx).padStart(2, "0");
  return `img/avatars/avatar${padded}.png`;
}

let categories = {};
let decksByCategory = {};
let sheetLoaded = false;

const gameState = {
  numPlayers: 3,
  currentPlayer: 1,
  selectedCategory: "aleatorio",
  secretWord: "",
  secretHint: "",
  impostorIndex: 1,
  roleShown: false,
  playerNames: [],
  playerAvatars: [],
  ordenRonda: [],
  starterPlayer: 1
};

function shuffle(arr) {
  for (let i = arr.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [arr[i], arr[j]] = [arr[j], arr[i]];
  }
}

function parseCsv(text) {
  const lines = text.split(/\r?\n/).filter(l => l.trim().length > 0);
  const [headerLine, ...rows] = lines;
  const headers = headerLine.split(",");

  const idxCategory = headers.indexOf("category");
  const idxWord     = headers.indexOf("word");
  const idxHint     = headers.indexOf("hint");

  const result = {};

  rows.forEach(line => {
    const parts = line.split(",");
    const cat   = parts[idxCategory]?.trim();
    const word  = parts[idxWord]?.trim();
    const hint  = parts[idxHint]?.trim();

    if (!cat || !word) return;

    if (!result[cat]) result[cat] = [];
    result[cat].push({
      word,
      hint: hint || ""
    });
  });

  return result;
}

async function loadWordsFromCsv() {
  try {
    const res = await fetch(CSV_URL);
    if (!res.ok) throw new Error("No se pudo cargar el CSV");
    const csvText = await res.text();

    categories = parseCsv(csvText);
    decksByCategory = {};

    Object.keys(categories).forEach(cat => {
      decksByCategory[cat] = [...categories[cat]];
      shuffle(decksByCategory[cat]);
    });

    decksByCategory.all = Object.values(categories).flat();
    shuffle(decksByCategory.all);

    sheetLoaded = true;
    console.log("CSV cargado. Categorías:", Object.keys(categories));
  } catch (err) {
    console.error("Error cargando CSV:", err);
    sheetLoaded = false;
  }
}

function showScreen(id) {
  document.querySelectorAll(".screen").forEach(s => s.classList.add("hidden"));
  const el = document.getElementById(id);
  if (el) el.classList.remove("hidden");
}

function backToStart() {
  showScreen("screen-start");
}

function goToSetup() {
  showScreen("screen-setup");
}

// ====== MODAL AVATARES ======
let avatarModalEl = null;
let avatarGridEl = null;
let avatarModalCloseBtn = null;
let currentAvatarPlayerIdx = null;
let currentAvatarImgEl = null;

function openAvatarModal(playerIdx, imgEl) {
  currentAvatarPlayerIdx = playerIdx;
  currentAvatarImgEl = imgEl;
  if (!avatarModalEl) return;
  avatarModalEl.classList.remove("hidden");
}

function closeAvatarModal() {
  if (!avatarModalEl) return;
  avatarModalEl.classList.add("hidden");
  currentAvatarPlayerIdx = null;
  currentAvatarImgEl = null;
}

function selectAvatar(avatarIndex) {
  if (currentAvatarPlayerIdx == null) return;
  gameState.playerAvatars[currentAvatarPlayerIdx] = avatarIndex;
  if (currentAvatarImgEl) {
    currentAvatarImgEl.src = avatarSrcFromIndex(avatarIndex);
  }
  closeAvatarModal();
}

function initAvatarModal() {
  avatarModalEl = document.getElementById("avatarModal");
  avatarGridEl = document.getElementById("avatarGrid");
  avatarModalCloseBtn = document.getElementById("avatarModalClose");

  if (!avatarModalEl || !avatarGridEl) return;

  avatarGridEl.innerHTML = "";

  for (let i = 1; i <= AVATAR_COUNT; i++) {
    const btn = document.createElement("button");
    btn.type = "button";
    btn.className = "avatar-option";

    const img = document.createElement("img");
    img.src = avatarSrcFromIndex(i);
    img.alt = `Avatar ${i}`;

    btn.appendChild(img);
    btn.addEventListener("click", () => selectAvatar(i));

    avatarGridEl.appendChild(btn);
  }

  if (avatarModalCloseBtn) {
    avatarModalCloseBtn.addEventListener("click", closeAvatarModal);
  }

  avatarModalEl.addEventListener("click", (e) => {
    if (e.target === avatarModalEl) {
      closeAvatarModal();
    }
  });
}

function refreshPlayerNameInputs() {
  const numSel    = document.getElementById("selectPlayers");
  const container = document.getElementById("playerNamesContainer");
  const n         = parseInt(numSel.value, 10);

  container.innerHTML = "";
  gameState.playerAvatars = gameState.playerAvatars || [];

  for (let i = 1; i <= n; i++) {
    const row = document.createElement("div");
    row.className = "player-row";

    const input = document.createElement("input");
    input.type = "text";
    input.placeholder = `Jugador ${i}`;
    input.id = `playerName${i}`;

    const idxArr = i - 1;

    if (!gameState.playerAvatars[idxArr]) {
      gameState.playerAvatars[idxArr] = ((idxArr % AVATAR_COUNT) + 1);
    }
    const avatarIndex = gameState.playerAvatars[idxArr];

    const avatarImg = document.createElement("img");
    avatarImg.className = "avatar-thumb";
    avatarImg.src = avatarSrcFromIndex(avatarIndex);
    avatarImg.alt = `Avatar jugador ${i}`;
    avatarImg.addEventListener("click", () => {
      openAvatarModal(idxArr, avatarImg);
    });

    row.appendChild(input);
    row.appendChild(avatarImg);
    container.appendChild(row);
  }
}

function drawWord(categoryKey) {
  const deckKey = categoryKey === "aleatorio" ? "all" : categoryKey;

  if (!decksByCategory[deckKey] || decksByCategory[deckKey].length === 0) {
    alert(
      deckKey === "all"
        ? "Se han usado todas las palabras. Se reinicia el pack completo."
        : `Se han usado todas las palabras de la categoría "${deckKey}". Se reinicia esa categoría.`
    );

    if (deckKey === "all") {
      decksByCategory.all = Object.values(categories).flat();
      shuffle(decksByCategory.all);
    } else {
      decksByCategory[deckKey] = [...categories[deckKey]];
      shuffle(decksByCategory[deckKey]);
    }
  }

  const deck = decksByCategory[deckKey];
  const idx  = Math.floor(Math.random() * deck.length);
  return deck.splice(idx, 1)[0];
}

function startGame() {
  const numSel = document.getElementById("selectPlayers");
  const catSel = document.getElementById("selectCategory");

  gameState.numPlayers       = parseInt(numSel.value, 10);
  gameState.selectedCategory = catSel.value;

  gameState.playerNames = [];
  for (let i = 1; i <= gameState.numPlayers; i++) {
    const input = document.getElementById(`playerName${i}`);
    const name  = (input && input.value.trim()) || `Jugador ${i}`;
    gameState.playerNames.push(name);
  }

  const card = drawWord(gameState.selectedCategory);
  gameState.secretWord = card.word;
  gameState.secretHint = card.hint || "";

  gameState.impostorIndex =
    Math.floor(Math.random() * gameState.numPlayers) + 1;

  gameState.starterPlayer =
    Math.floor(Math.random() * gameState.numPlayers) + 1;

  gameState.ordenRonda = [];
  for (let i = 1; i <= gameState.numPlayers; i++) {
    gameState.ordenRonda.push(i);
  }
  shuffle(gameState.ordenRonda);

  gameState.currentPlayer = 1;

  prepareCurrentPlayerScreen();
  showScreen("screen-role");
}

function startAnotherRound() {
  const card = drawWord(gameState.selectedCategory);
  gameState.secretWord = card.word;
  gameState.secretHint = card.hint || "";
  gameState.impostorIndex =
    Math.floor(Math.random() * gameState.numPlayers) + 1;

  gameState.starterPlayer =
    Math.floor(Math.random() * gameState.numPlayers) + 1;

  gameState.ordenRonda = [];
  for (let i = 1; i <= gameState.numPlayers; i++) {
    gameState.ordenRonda.push(i);
  }
  shuffle(gameState.ordenRonda);

  gameState.currentPlayer = 1;

  prepareCurrentPlayerScreen();
  showScreen("screen-role");
}

const cardFrontEl    = document.getElementById("cardFront");
const nextBtnEl      = document.getElementById("nextPlayerBtn");
const toggleRoleBtn  = document.getElementById("toggleRoleBtn");

if (isTouch && toggleRoleBtn) {
  toggleRoleBtn.style.display = "none";
}

let cardLiftedByButton = false;

const instructionText = document.getElementById("instructionText");
if (instructionText) {
  instructionText.innerHTML = isTouch
    ? "Desliza hacia arriba para ver tu rol.<br>Suelta para bajarla."
    : "Haz clic en el botón para ver u ocultar tu rol.";
}

function prepareCurrentPlayerScreen() {
  const orderBadge = document.getElementById("playerOrder");
  const roleTitle  = document.getElementById("roleTitle");
  const roleWord   = document.getElementById("roleWord");
  const roleTip    = document.getElementById("roleTip");

  const turnIndex = gameState.currentPlayer;

  const realPlayer =
    gameState.ordenRonda && gameState.ordenRonda.length === gameState.numPlayers
      ? gameState.ordenRonda[turnIndex - 1]
      : turnIndex;

  const idx = realPlayer - 1;

  const isImpostor = realPlayer === gameState.impostorIndex;

  const name =
    gameState.playerNames[idx] ||
    `Jugador ${realPlayer}`;

  const bigNameEl = document.getElementById("playerNameBig");
  if (bigNameEl) {
    bigNameEl.textContent = name;
  }

  const avatarIndex =
    gameState.playerAvatars[idx] ||
    ((idx % AVATAR_COUNT) + 1);

  const avatarEl = document.getElementById("frontAvatar");
  if (avatarEl) {
    avatarEl.src = avatarSrcFromIndex(avatarIndex);
  }

  if (orderBadge) {
    orderBadge.textContent = `${turnIndex} de ${gameState.numPlayers}`;
  }

  if (isImpostor) {
    roleTitle.textContent = "Impostorcillo";
    roleWord.textContent  = "???";
    roleTip.textContent   =
      "No conoces la palabra secreta. Escucha y finge normalidad.";
  } else {
    roleTitle.textContent = "Ciudadano";
    roleWord.textContent  = `"${gameState.secretWord}"`;
    roleTip.textContent   =
      gameState.secretHint || "Da pistas sin decir la palabra directamente.";
  }

  gameState.roleShown = false;
  nextBtnEl.classList.add("hidden");
  nextBtnEl.classList.remove("active");

  cardFrontEl.style.transform = "translateY(0)";
  cardLiftedByButton = false;
  if (toggleRoleBtn) toggleRoleBtn.textContent = "Mostrar rol";
}

if (toggleRoleBtn) {
  toggleRoleBtn.addEventListener("click", () => {
    const slider = cardFrontEl.parentElement;
    const h = slider.offsetHeight || 300;

    if (!cardLiftedByButton) {
      cardFrontEl.style.transition = "transform 0.25s ease";
      cardFrontEl.style.transform = `translateY(${-h * 0.7}px)`;

      setTimeout(() => {
        cardFrontEl.style.transition = "";
      }, 260);

      if (!gameState.roleShown) {
        gameState.roleShown = true;
        nextBtnEl.classList.remove("hidden");
        nextBtnEl.classList.add("active");
      }

      toggleRoleBtn.textContent = "Ocultar rol";
      cardLiftedByButton = true;
    } else {
      cardFrontEl.style.transition = "transform 0.25s ease";
      cardFrontEl.style.transform = "translateY(0)";

      setTimeout(() => {
        cardFrontEl.style.transition = "";
      }, 260);

      toggleRoleBtn.textContent = "Mostrar rol";
      cardLiftedByButton = false;
    }
  });
}

function nextPlayer() {
  nextBtnEl.classList.remove("active");
  nextBtnEl.classList.add("hidden");

  gameState.currentPlayer++;

  if (gameState.currentPlayer > gameState.numPlayers) {
    const starterIndex = gameState.starterPlayer || 1;
    const starterName =
      gameState.playerNames[starterIndex - 1] ||
      `Jugador ${starterIndex}`;
    const starterEl = document.getElementById("starterInfo");
    if (starterEl) {
      starterEl.textContent = `Empieza diciendo su pista: ${starterName}`;
    }

    showScreen("screen-debate");
    return;
  }

  prepareCurrentPlayerScreen();
  showScreen("screen-role");
}

function prepareRevealScreen() {
  document.getElementById("finalWord").textContent = gameState.secretWord;

  const impostorName =
    gameState.playerNames[gameState.impostorIndex - 1] ||
    `Jugador ${gameState.impostorIndex}`;

  document.getElementById("impostorPlayer").textContent = impostorName;
}

document.getElementById("btnGoReveal").addEventListener("click", () => {
  prepareRevealScreen();
  showScreen("screen-reveal");
});

let dragStartY = 0;
let dragging   = false;
let cardHeight = 0;

function onTouchStart(e) {
  const slider = cardFrontEl.parentElement;
  cardHeight   = slider.offsetHeight || 300;

  dragStartY = e.touches[0].clientY;
  dragging   = true;
  cardFrontEl.style.transition = "none";

  cardLiftedByButton = false;
  if (toggleRoleBtn) toggleRoleBtn.textContent = "Mostrar rol";
}

function onTouchMove(e) {
  if (!dragging) return;

  const currentY = e.touches[0].clientY;
  let delta = currentY - dragStartY;

  if (delta > 0) delta = 0;
  if (delta < -cardHeight) delta = -cardHeight;

  cardFrontEl.style.transform = `translateY(${delta}px)`;

  if (delta < -cardHeight / 3 && !gameState.roleShown) {
    gameState.roleShown = true;
    nextBtnEl.classList.remove("hidden");
    nextBtnEl.classList.add("active");
  }
}

function onTouchEnd() {
  if (!dragging) return;
  dragging = false;

  cardFrontEl.style.transition = "transform 0.25s ease";
  cardFrontEl.style.transform = "translateY(0)";

  setTimeout(() => {
    cardFrontEl.style.transition = "";
  }, 250);
}

cardFrontEl.addEventListener("touchstart", onTouchStart, { passive: true });
cardFrontEl.addEventListener("touchmove",  onTouchMove,  { passive: true });
cardFrontEl.addEventListener("touchend",   onTouchEnd);

document.getElementById("selectPlayers")
  .addEventListener("change", refreshPlayerNameInputs);

loadWordsFromCsv();
refreshPlayerNameInputs();
showScreen("screen-start");

const versionEl = document.getElementById("appVersion");
if (versionEl) {
  versionEl.textContent = "Versión " + APP_VERSION;
}

initAvatarModal();
</script>
</body>
</html>
