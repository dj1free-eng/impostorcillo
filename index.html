<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>El Impostorcillo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    * {
      box-sizing: border-box;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    body {
      margin: 0;
      background: radial-gradient(circle at top, #1f2937 0, #020617 45%, #000 100%);
      color: #f5f5f5;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
    }

    .app {
      width: 100%;
      max-width: 480px;
      padding: 16px;
    }

    .card {
      background: rgba(15, 23, 42, 0.95);
      border-radius: 20px;
      padding: 24px 20px 20px;
      box-shadow: 0 20px 40px rgba(0,0,0,0.6);
      position: relative;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(148, 163, 184, 0.3);
    }

    h1, h2, h3 {
      margin-top: 0;
      text-align: center;
    }

    h1 {
      font-size: 1.9rem;
      margin-bottom: 0.5rem;
    }

    p {
      line-height: 1.4;
    }

    label {
      display: block;
      margin: 10px 0 4px;
      font-size: 0.9rem;
      opacity: 0.9;
    }

    input, select {
      width: 100%;
      padding: 8px 10px;
      border-radius: 8px;
      border: none;
      font-size: 1rem;
      margin-bottom: 8px;
    }

    /* Botones normales del juego */
    button {
      width: 100%;
      padding: 12px;
      border-radius: 999px;
      border: none;
      font-size: 1rem;
      font-weight: 600;
      margin-top: 14px;
      cursor: pointer;
      background: linear-gradient(135deg, #22c55e, #16a34a);
      color: #fff;
      box-shadow: 0 6px 16px rgba(22, 163, 74, 0.5);
      transition: transform 0.1s ease, box-shadow 0.1s ease, opacity 0.15s ease;
    }

    button.secondary {
      background: #374151;
      box-shadow: none;
    }

    button:active {
      transform: translateY(1px);
      box-shadow: 0 3px 8px rgba(22, 163, 74, 0.4);
      opacity: 0.9;
    }

    .small {
      font-size: 0.85rem;
      text-align: center;
      opacity: 0.8;
      margin-top: 12px;
    }

    .hidden {
      display: none;
    }

    .badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      background: #1f2937;
      color: #9ca3af;
      margin-bottom: 10px;
    }

    .center {
      text-align: center;
    }

    .highlight {
      color: #22c55e;
      font-weight: 700;
    }

    /* Bot√≥n peque√±o de men√∫ */
    .menu-button {
      position: absolute;
      top: -14px;
      right: -14px;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      border: none;
      cursor: pointer;
      background: #374151;
      color: #e5e7eb;
      font-size: 0.7rem;
      box-shadow: 0 2px 6px rgba(0,0,0,0.4);
      padding: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      width: 32px !important;
      z-index: 10;
    }

    .menu-button span {
      pointer-events: none;
    }

    .menu-button:hover {
      opacity: 1;
    }

    /* Pantalla inicio: hero */
    .hero-illustration {
      display: flex;
      justify-content: center;
      margin-bottom: 16px;
    }

    .hero-illustration img {
      width: 80%;
      max-width: 260px;
      border-radius: 24px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.5);
    }

    /* Cabecera configuraci√≥n con icono */
    .title-row {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      margin-bottom: 4px;
    }

    .title-icon {
      width: 56px;
      height: 56px;
      border-radius: 50%;
      box-shadow: 0 4px 12px rgba(0,0,0,0.4);
    }

    /* Carta deslizable para rol */
    .role-badge-row {
      text-align: center;
      margin-bottom: 8px;
    }

    .card-slider {
      width: 100%;
      height: 340px;
      background: #f9fafb;
      border-radius: 24px;
      overflow: hidden;
      position: relative;
      touch-action: none;
      box-shadow: 0 12px 30px rgba(0,0,0,0.4);
      margin-bottom: 10px;
    }

    .card-back {
      position: absolute;
      inset: 0;
      background: #ffffff;
      border-radius: 24px;
      padding: 24px 16px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      text-align: center;
    }

    .card-front {
      position: absolute;
      inset: 0;
      background: #ffffff;
      border-radius: 24px;
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
      align-items: center;
      touch-action: none;
    }

    .card-front-img {
      width: 100%;
      height: 72%;
      object-fit: contain;
    }

    .slide-text {
      text-align: center;
      font-size: 1rem;
      margin-top: 6px;
      color: #4b5563;
    }

    #roleTitle {
      font-size: 1.6rem;
      margin-bottom: 8px;
      color: #111827;
    }

    #roleWord {
      font-size: 1.8rem;
      font-weight: 700;
      color: #111827;
      margin-bottom: 8px;
    }

    .role-tip {
      font-size: 0.9rem;
      color: #4b5563;
      max-width: 260px;
    }
  </style>
</head>
<body>
  <div class="app">
    <div class="card">
      <!-- Bot√≥n men√∫ global -->
      <button class="menu-button" onclick="goToSetup()">
        <span>‚â°</span>
      </button>

      <!-- Pantalla: Inicio -->
      <div id="screen-start">
        <div class="hero-illustration">
          <img src="img/impostor-hero.png" alt="Impostorcillo">
        </div>
        <h1>El Impostorcillo</h1>
        <p class="center">
          El juego social de deducci√≥n y enga√±o.<br>
          ¬°Intenta no parecer sospechoso!
        </p>
        <button onclick="goToSetup()">Nueva partida</button>
      </div>

      <!-- Pantalla: Configuraci√≥n -->
      <div id="screen-setup" class="hidden">
        <div class="title-row">
          <img src="img/impostor-icon.png" class="title-icon" alt="">
          <h2>Configuraci√≥n</h2>
        </div>

        <label for="numPlayers">N√∫mero de jugadores</label>
        <select id="numPlayers">
          <option value="3" selected>3 jugadores</option>
          <option value="4">4 jugadores</option>
          <option value="5">5 jugadores</option>
          <option value="6">6 jugadores</option>
          <option value="7">7 jugadores</option>
          <option value="8">8 jugadores</option>
          <option value="9">9 jugadores</option>
          <option value="10">10 jugadores</option>
          <option value="11">11 jugadores</option>
          <option value="12">12 jugadores</option>
        </select>

        <label for="category">Categor√≠a</label>
        <select id="category">
          <option value="random">Aleatorio</option>
          <option value="comida">Comida</option>
          <option value="sitios">Lugares</option>
          <option value="peliculas">Pel√≠culas</option>
          <option value="objetos">Objetos</option>
        </select>

        <button onclick="startGame()">Empezar</button>
        <button class="secondary" onclick="backToStart()">Volver</button>

        <p class="small">
          Modo actual: 1 solo Impostorcillo, votos y acusaciones se hacen de viva voz.
        </p>
      </div>

      <!-- Pantalla: Rol del jugador (con carta deslizable) -->
      <div id="screen-role" class="hidden">
        <div class="role-badge-row">
          <span class="badge" id="playerBadge"></span>
        </div>

        <div class="card-slider">
  <!-- Parte trasera: el rol -->
  <div class="card-back">
    <h3 id="roleTitle"></h3>
    <div id="roleWord"></div>
    <p class="role-tip" id="roleTip"></p>
  </div>

  <!-- Parte frontal: la que se arrastra -->
  <div class="card-front" id="cardFront">
    <img src="img/group-players.png" class="card-front-img" alt="Jugadores">
    <p class="slide-text">Desliza hacia arriba para ver tu rol</p>
  </div>
</div>

        <p class="small">
  Mant√©n el dedo mientras lees tu rol.<br>
  Al soltar, la carta baja y lo tapa de nuevo.
</p>

<button id="nextPlayerBtn" class="secondary hidden" onclick="nextPlayer()">
  Jugador siguiente
</button>
      </div>

      <!-- Pantalla: Debate / votaci√≥n -->
      <div id="screen-vote" class="hidden">
        <h2>Debatid y votad</h2>
        <p class="center">
          Todos hab√©is visto ya vuestro rol.<br/><br/>
          Ahora:
        </p>
        <ul style="font-size:0.95rem; line-height:1.5;">
          <li>Dad una pista cada uno, sin decir la palabra.</li>
          <li>Comentad y acusad a quien cre√°is que es el Impostorcillo.</li>
          <li>Haced una votaci√≥n final.</li>
        </ul>
        <p class="small">
          Cuando teng√°is decidido qui√©n es el Impostorcillo,<br/>
          pulsad el bot√≥n de abajo para ver el resultado real.
        </p>
        <button onclick="revealRoles()">Revelar resultado</button>
      </div>

      <!-- Pantalla: Revelaci√≥n final -->
      <div id="screen-reveal" class="hidden">
        <h2>Revelaci√≥n</h2>
        <p class="center">La palabra secreta era:</p>
        <div style="font-size:1.9rem; text-align:center; margin: 12px 0;" id="finalWord"></div>
        <p class="center">
          El Impostorcillo era el <span class="highlight" id="impostorPlayer"></span>.
        </p>
        <p class="small">
          ¬øHab√©is acertado? ¬øO el Impostorcillo os ha liado a todos? üòà
        </p>
        <button onclick="goToSetup()">Jugar otra vez</button>
        <button class="secondary" onclick="backToStart()">Salir al inicio</button>
      </div>
    </div>
  </div>

  <script>
    // ==============================
    // BASE DE DATOS (JSON externo)
    // ==============================

    let WORDS_DB = [];
    let decksByCategory = {}; // baraja por categor√≠a o 'all'

    function shuffle(array) {
      for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
      }
    }

    function resetCategoryDeck(categoryKey) {
      if (!WORDS_DB || WORDS_DB.length === 0) return;

      let words;
      if (categoryKey === 'all') {
        words = WORDS_DB.filter(w => w.type === 'word');
      } else {
        words = WORDS_DB.filter(w => w.type === 'word' && w.category === categoryKey);
      }

      decksByCategory[categoryKey] = [...words];
      shuffle(decksByCategory[categoryKey]);
      console.log(`Baraja de "${categoryKey}" reiniciada con`, decksByCategory[categoryKey].length, 'palabras.');
    }

    async function loadWordsDb() {
      try {
        const res = await fetch('data/words-es.json');
        if (!res.ok) throw new Error('No se pudo cargar data/words-es.json');
        const data = await res.json();
        if (Array.isArray(data)) {
          WORDS_DB = data;
          console.log('Base de datos cargada:', WORDS_DB.length, 'entradas');
          resetCategoryDeck('all');
        } else {
          console.error('El JSON de palabras no es un array');
        }
      } catch (err) {
        console.error('Error cargando base de datos:', err);
      }
    }

    loadWordsDb();

    // ==============================
    // ESTADO DEL JUEGO
    // ==============================

    let gameState = {
      numPlayers: 0,
      currentPlayer: 1,
      secretWord: "",
      impostorIndex: 1,
      roleShown: false,
      currentCategory: "random"
    };

    // ==============================
    // UTILIDADES
    // ==============================

    function showScreen(id) {
      ["screen-start","screen-setup","screen-role","screen-vote","screen-reveal"]
        .forEach(s => document.getElementById(s).classList.add("hidden"));
      document.getElementById(id).classList.remove("hidden");
    }

    function backToStart() {
      showScreen("screen-start");
    }

    function goToSetup() {
      showScreen("screen-setup");
    }

    function getRandomFromArray(arr) {
      return arr[Math.floor(Math.random() * arr.length)];
    }

    function getRandomWord(categoryKey) {
      if (!WORDS_DB || WORDS_DB.length === 0) {
        const fallback = ["Impostor", "Misterio", "Secreto", "Sombra"];
        return getRandomFromArray(fallback);
      }

      const deckKey = (categoryKey === 'random') ? 'all' : categoryKey;

      if (!decksByCategory[deckKey]) {
        resetCategoryDeck(deckKey);
      }

      let deck = decksByCategory[deckKey] || [];

      if (deck.length === 0) {
        if (deckKey === 'all') {
          alert("Se han usado todas las palabras disponibles. Se reinicia la baraja completa.");
        } else {
          alert(`Se han usado todas las palabras de la categor√≠a "${deckKey}". Se reinicia solo ese pack.`);
        }
        resetCategoryDeck(deckKey);
        deck = decksByCategory[deckKey] || [];
      }

      if (deck.length === 0) {
        const fallback = ["Impostor", "Misterio", "Secreto", "Sombra"];
        return getRandomFromArray(fallback);
      }

      const idx = Math.floor(Math.random() * deck.length);
      const chosen = deck.splice(idx, 1)[0];
      decksByCategory[deckKey] = deck;

      return chosen.text;
    }

    // ==============================
    // L√ìGICA PRINCIPAL
    // ==============================

    function startGame() {
      const numPlayersInput = document.getElementById("numPlayers");
      const categorySelect = document.getElementById("category");

      let n = parseInt(numPlayersInput.value, 10);
      if (isNaN(n) || n < 3) n = 3;
      if (n > 12) n = 12;

      const cat = categorySelect.value;

      gameState.numPlayers = n;
      gameState.currentPlayer = 1;
      gameState.secretWord = getRandomWord(cat);
      gameState.impostorIndex = Math.floor(Math.random() * n) + 1;
      gameState.roleShown = false;
      gameState.currentCategory = cat;

      prepareCurrentPlayerScreen();
      showScreen("screen-role");
    }

    function prepareCurrentPlayerScreen() {
      const badge = document.getElementById("playerBadge");
      const roleTitleEl = document.getElementById("roleTitle");
      const roleWordEl = document.getElementById("roleWord");
      const roleTipEl = document.getElementById("roleTip");
      const nextBtn = document.getElementById("nextPlayerBtn");
      const cardFront = document.getElementById("cardFront");

      badge.textContent = `Jugador ${gameState.currentPlayer} de ${gameState.numPlayers}`;
      gameState.roleShown = false;
      nextBtn.classList.add("hidden");

      // Reset posici√≥n de la carta frontal
      cardFront.style.transform = "translateY(0)";

      if (gameState.currentPlayer === gameState.impostorIndex) {
        roleTitleEl.textContent = "Eres el Impostorcillo üòà";
        roleWordEl.textContent = "???";
        roleTipEl.textContent = "No conoces la palabra secreta. Escucha las pistas de los dem√°s, improvisa y finge que t√∫ tambi√©n la sabes.";
      } else {
        roleTitleEl.textContent = "Eres ciudadano üë§";
        roleWordEl.textContent = gameState.secretWord;
        roleTipEl.textContent = "Conoces la palabra secreta. Da pistas sin decirla directamente, pero sin que te confundan con el Impostorcillo.";
      }
    }

    function nextPlayer() {
      if (!gameState.roleShown) return;

      if (gameState.currentPlayer < gameState.numPlayers) {
        gameState.currentPlayer += 1;
        prepareCurrentPlayerScreen();
        showScreen("screen-role");
      } else {
        showScreen("screen-vote");
      }
    }

    function revealRoles() {
      document.getElementById("finalWord").textContent = gameState.secretWord;
      document.getElementById("impostorPlayer").textContent = `Jugador ${gameState.impostorIndex}`;
      showScreen("screen-reveal");
    }

// ==============================
// DESLIZAR CARTA (PRIVACIDAD DEL ROL)
// ==============================

const cardFrontEl = document.getElementById("cardFront");
const nextBtnEl = document.getElementById("nextPlayerBtn");

let dragStartY = 0;
let dragging = false;
let cardHeight = 0;

function onTouchStart(e) {
  const slider = cardFrontEl.parentElement; // .card-slider
  cardHeight = slider.offsetHeight || 300;

  dragStartY = e.touches[0].clientY;
  dragging = true;

  cardFrontEl.style.transition = "none";
}

function onTouchMove(e) {
  if (!dragging) return;

  const currentY = e.touches[0].clientY;
  let delta = currentY - dragStartY;   // negativo = hacia arriba

  // No permitimos bajar, solo subir
  if (delta > 0) delta = 0;

  // L√≠mite: que pueda salir casi del todo
  const minDelta = -cardHeight; // se va completamente fuera
  if (delta < minDelta) delta = minDelta;

  cardFrontEl.style.transform = `translateY(${delta}px)`;

  // Si ha subido m√°s de un tercio de la carta, contamos que ha visto el rol
  if (delta < -cardHeight / 3 && !gameState.roleShown) {
    gameState.roleShown = true;
    nextBtnEl.classList.remove("hidden");
  }
}

function onTouchEnd() {
  if (!dragging) return;
  dragging = false;

  cardFrontEl.style.transition = "transform 0.25s ease";
  cardFrontEl.style.transform = "translateY(0)";

  setTimeout(() => {
    cardFrontEl.style.transition = "";
  }, 250);
}

cardFrontEl.addEventListener("touchstart", onTouchStart, { passive: true });
cardFrontEl.addEventListener("touchmove", onTouchMove, { passive: true });
cardFrontEl.addEventListener("touchend", onTouchEnd);
  </script>
</body>
</html>
