<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>El Impostorcillo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
* {
  box-sizing: border-box;
  font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
}

body {
  margin: 0;
  background: radial-gradient(circle at top, #1f2937 0, #020617 45%, #000 100%);
  color: #f5f5f5;
  display: flex;
  justify-content: center;
  align-items: center;
  min-height: 100vh;
}

.app {
  width: 100%;
  max-width: 480px;
  padding: 16px;
}

.card {
  background: rgba(15, 23, 42, 0.95);
  border-radius: 20px;
  padding: 24px 20px 20px;
  box-shadow: 0 20px 40px rgba(0,0,0,0.6);
  position: relative;
  backdrop-filter: blur(10px);
  border: 1px solid rgba(148, 163, 184, 0.3);
}

.screen.hidden {
  display: none;
}

h1, h2, h3 {
  margin-top: 0;
  text-align: center;
}

h1 {
  font-size: 1.9rem;
  margin-bottom: 0.5rem;
}

p {
  line-height: 1.4;
}

label {
  display: block;
  margin: 10px 0 4px;
  font-size: 0.9rem;
  opacity: 0.9;
}

input, select {
  width: 100%;
  padding: 8px 10px;
  border-radius: 8px;
  border: none;
  font-size: 1rem;
  margin-bottom: 8px;
}

/* Botones */
button {
  width: 100%;
  padding: 12px;
  border-radius: 999px;
  border: none;
  font-size: 1rem;
  font-weight: 600;
  margin-top: 14px;
  cursor: pointer;
  background: linear-gradient(135deg, #22c55e, #16a34a);
  color: #fff;
  box-shadow: 0 6px 16px rgba(22, 163, 74, 0.5);
  transition: transform 0.1s ease, box-shadow 0.1s ease, opacity 0.15s ease;
}

button.secondary {
  background: #374151;
  box-shadow: none;
}

button:active {
  transform: translateY(1px);
  box-shadow: 0 3px 8px rgba(22, 163, 74, 0.4);
  opacity: 0.9;
}

.small {
  font-size: 0.85rem;
  text-align: center;
  opacity: 0.8;
  margin-top: 12px;
}

.hidden {
  display: none;
}

.badge {
  display: inline-block;
  padding: 4px 10px;
  border-radius: 999px;
  font-size: 0.75rem;
  text-transform: uppercase;
  letter-spacing: 0.05em;
  background: #1f2937;
  color: #9ca3af;
  margin-bottom: 10px;
}

.center {
  text-align: center;
}

.highlight {
  color: #22c55e;
  font-weight: 700;
}

/* Botón pequeño menú */
.menu-button {
  position: absolute;
  top: -14px;
  right: -14px;
  width: 32px;
  height: 32px;
  border-radius: 50%;
  border: none;
  cursor: pointer;
  background: #374151;
  color: #e5e7eb;
  font-size: 0.7rem;
  box-shadow: 0 2px 6px rgba(0,0,0,0.4);
  padding: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 10;
}

.menu-button span {
  pointer-events: none;
}

/* Inicio */
.hero-illustration {
  display: flex;
  justify-content: center;
  margin-bottom: 16px;
}

.hero-illustration img {
  width: 80%;
  max-width: 260px;
  border-radius: 24px;
  box-shadow: 0 10px 30px rgba(0,0,0,0.5);
}

.version-label {
  text-align: center;
  font-size: 0.75rem;
  opacity: 0.6;
  margin-top: 8px;
}

/* Configuración */
.title-row {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 10px;
  margin-bottom: 4px;
}

.title-icon {
  width: 56px;
  height: 56px;
  border-radius: 50%;
  box-shadow: 0 4px 12px rgba(0,0,0,0.4);
}

.player-row {
  display: flex;
  gap: 8px;
  align-items: center;
  margin-bottom: 6px;
}

.player-row input {
  flex: 2;
  margin-bottom: 0;
}

.player-row select {
  flex: 1;
  margin-bottom: 0;
}

/* Pantalla de rol */
.player-name-big {
  font-size: 1.8rem;
  font-weight: 800;
  text-align: center;
  margin: 4px 0 12px;
}

/* Carta deslizable */
.card-slider {
  width: 100%;
  height: 340px;
  background: radial-gradient(circle at top, #020617 0, #020617 60%, #000 100%);
  border-radius: 24px;
  overflow: hidden;
  position: relative;
  touch-action: none;
  box-shadow: 0 12px 30px rgba(0,0,0,0.7);
  margin-bottom: 18px;
  border: 1px solid rgba(148,163,184,0.4);
}

.card-back,
.card-front {
  position: absolute;
  inset: 10px;
  border-radius: 20px;
  overflow: hidden;
}

/* Marco común de carta */
.card-frame {
  width: 100%;
  height: 100%;
  object-fit: contain;
  display: block;
}

/* Cara trasera */
.card-back {
  display: flex;
  align-items: center;
  justify-content: center;
}

.card-back-content {
  position: absolute;
  top: 50%;
  left: 50%;
  width: 70%;
  transform: translate(-50%, -52%);
  text-align: center;
}

#roleTitle {
  font-size: 1.4rem;
  margin-bottom: 6px;
  color: #111827;
}

#roleWord {
  font-size: 1.7rem;
  font-weight: 800;
  color: #111827;
  margin-bottom: 8px;
}

.role-tip {
  font-size: 0.95rem;
  color: #111827;
}

/* Cara frontal */
.card-front {
  display: flex;
  align-items: center;
  justify-content: center;
}

.card-front-inner {
  position: absolute;
  inset: 0;
}

.front-avatar {
  position: absolute;
  top: 31%;
  left: 50%;
  width: 48%;
  max-width: 180px;
  transform: translate(-50%, -55%);
  border-radius: 50%;
  border: 6px solid #fefce8;
  box-shadow: 0 6px 18px rgba(0,0,0,0.6);
  object-fit: cover;
}

.card-front-label {
  position: absolute;
  bottom: 16%;
  left: 50%;
  transform: translateX(-50%);
  width: 70%;
  text-align: center;
  color: #111827;
  font-weight: 600;
  font-size: 0.95rem;
}

/* Botón siguiente bajo la carta */
#nextPlayerBtn {
  background: #3f3f46;
  color: #d4d4d8;
  opacity: 0.5;
  border-radius: 12px;
  padding: 14px 24px;
  font-size: 1.05rem;
  border: none;
  width: 90%;
  max-width: 320px;
  margin: 16px auto 0;
  display: none;
  box-shadow: none;
}

#nextPlayerBtn.active {
  background: linear-gradient(135deg, #16a34a, #22c55e);
  color: #ffffff;
  opacity: 1;
  box-shadow: 0 0 12px rgba(34,197,94,0.6);
}

/* Botón de mostrar rol sólo escritorio (se controla también por JS) */
#toggleRoleBtn {
  width: 70%;
  max-width: 260px;
  margin: 4px auto 0;
}

/* Pequeño indicador arriba izquierda (orden) */
.role-header {
  text-align: left;
  margin-bottom: 4px;
}
  </style>
</head>
<body>
  <div class="app">
    <div class="card">
      <button class="menu-button" onclick="goToSetup()">
        <span>≡</span>
      </button>

      <!-- PANTALLA: INICIO -->
      <div id="screen-start" class="screen">
        <div class="hero-illustration">
          <img src="img/impostor-hero.png" alt="Impostorcillo">
        </div>

        <h1>El Impostorcillo</h1>
        <p class="center">
          El juego social de deducción y engaño.<br>
          ¡Intenta no parecer sospechoso!
        </p>

        <button onclick="goToSetup()">Nueva partida</button>
        <p id="versionLabel" class="version-label"></p>
      </div>

      <!-- PANTALLA: CONFIGURACIÓN -->
      <div id="screen-setup" class="screen hidden">
        <div class="title-row">
          <img src="img/impostor-icon.png" class="title-icon" alt="Icono">
          <h2>Configuración</h2>
        </div>

        <label for="selectPlayers">Número de jugadores</label>
        <select id="selectPlayers">
          <option value="3" selected>3 jugadores</option>
          <option value="4">4 jugadores</option>
          <option value="5">5 jugadores</option>
          <option value="6">6 jugadores</option>
          <option value="7">7 jugadores</option>
          <option value="8">8 jugadores</option>
          <option value="9">9 jugadores</option>
          <option value="10">10 jugadores</option>
        </select>

        <label>Nombre de los jugadores y avatar</label>
        <div id="playerNamesContainer"></div>

        <label for="selectCategory">Categoría</label>
        <select id="selectCategory">
          <option value="aleatorio">Aleatorio</option>
          <option value="comida">Comida</option>
          <option value="animales">Animales</option>
          <option value="objetos">Objetos</option>
          <option value="sitios">Sitios</option>
          <option value="deportes">Deportes</option>
          <option value="videojuegos">Videojuegos</option>
          <option value="transportes">Transportes</option>
        </select>

        <button onclick="startGame()">Empezar</button>
        <button class="secondary" onclick="backToStart()">Volver</button>

        <p class="small">
          Modo actual: 1 Impostorcillo por ronda. Las acusaciones se hacen hablando.
        </p>
      </div>

      <!-- PANTALLA: ROL DEL JUGADOR -->
      <div id="screen-role" class="screen hidden">
        <div class="role-header">
          <span id="playerOrder" class="badge"></span>
        </div>

        <h2 id="playerNameBig" class="player-name-big"></h2>

        <div class="card-slider">
          <!-- Parte trasera: rol -->
          <div class="card-back">
            <img src="img/card-frame-back.png" alt="carta trasera" class="card-frame">
            <div class="card-back-content">
              <h3 id="roleTitle"></h3>
              <div id="roleWord"></div>
              <p class="role-tip" id="roleTip"></p>
            </div>
          </div>

          <!-- Parte frontal: carta que se desliza -->
          <div class="card-front" id="cardFront">
            <div class="card-front-inner">
              <img src="img/card-frame-front.png" alt="carta frontal" class="card-frame">
              <img id="frontAvatar" class="front-avatar" src="img/avatars/avatar1.png" alt="Avatar">
              <div class="card-front-label">
                <p id="slideInstruction">Desliza hacia arriba para ver tu rol.<br>Suelta para bajarla.</p>
              </div>
            </div>
          </div>
        </div>

        <p class="small" id="roleInstructionText"></p>

        <button id="toggleRoleBtn" class="secondary" style="display:none;">
          Mostrar rol
        </button>

        <button id="nextPlayerBtn" class="secondary">
          Jugador siguiente
        </button>
      </div>

      <!-- PANTALLA: DEBATE -->
      <div id="screen-debate" class="screen hidden">
        <h2>Debatid y votad</h2>
        <p class="center">
          Todos han visto ya su rol.<br><br>
          Ahora toca hablar:
        </p>
        <ul style="font-size:0.95rem; line-height:1.5;">
          <li>Cada jugador dice una pista sobre la palabra.</li>
          <li>Comentad, defendedos y acusad al sospechoso.</li>
          <li>Haced una votación final.</li>
        </ul>

        <button id="btnGoReveal">Ver resultado</button>
      </div>

      <!-- PANTALLA: REVELACIÓN -->
      <div id="screen-reveal" class="screen hidden">
        <h2>Revelación</h2>

        <p class="center">La palabra secreta era:</p>
        <div id="finalWord" style="font-size:1.9rem; text-align:center; margin:12px 0;"></div>

        <p class="center">
          El Impostorcillo era<br>
          <span class="highlight" id="impostorPlayer"></span>
        </p>

        <button onclick="startAnotherRound()">Jugar otra ronda</button>
        <button class="secondary" onclick="backToStart()">Volver al inicio</button>
      </div>

    </div>
  </div>

  <script>
  const CSV_URL = "data/words-es.csv";
  const AVATAR_COUNT = 8;
  const APP_VERSION = "0.4.0";

  const isTouch =
    "ontouchstart" in window ||
    (navigator && navigator.maxTouchPoints > 0);

  let categories = {};
  let decksByCategory = {};
  let sheetLoaded = false;

  const gameState = {
    numPlayers: 3,
    currentPlayer: 1,
    selectedCategory: "aleatorio",
    secretWord: "",
    secretHint: "",
    impostorIndex: 1,
    roleShown: false,
    playerNames: [],
    playerAvatars: [],
    ordenRonda: []
  };

  function shuffle(arr) {
    for (let i = arr.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [arr[i], arr[j]] = [arr[j], arr[i]];
    }
  }

  function parseCsv(text) {
    const lines = text.split(/\r?\n/).filter(l => l.trim().length > 0);
    const [headerLine, ...rows] = lines;
    const headers = headerLine.split(",");

    const idxCategory = headers.indexOf("category");
    const idxWord     = headers.indexOf("word");
    const idxHint     = headers.indexOf("hint");

    const result = {};

    rows.forEach(line => {
      const parts = line.split(",");
      const cat   = parts[idxCategory]?.trim();
      const word  = parts[idxWord]?.trim();
      const hint  = parts[idxHint]?.trim();

      if (!cat || !word) return;

      if (!result[cat]) result[cat] = [];
      result[cat].push({
        word,
        hint: hint || ""
      });
    });

    return result;
  }

  async function loadWordsFromCsv() {
    try {
      const res = await fetch(CSV_URL);
      if (!res.ok) throw new Error("No se pudo cargar el CSV");
      const csvText = await res.text();

      categories = parseCsv(csvText);
      decksByCategory = {};

      Object.keys(categories).forEach(cat => {
        decksByCategory[cat] = [...categories[cat]];
        shuffle(decksByCategory[cat]);
      });

      decksByCategory.all = Object.values(categories).flat();
      shuffle(decksByCategory.all);

      sheetLoaded = true;
      console.log("CSV cargado. Categorías:", Object.keys(categories));
    } catch (err) {
      console.error("Error cargando CSV:", err);
      sheetLoaded = false;
    }
  }

  function showScreen(id) {
    document.querySelectorAll(".screen").forEach(s =>
      s.classList.add("hidden")
    );
    document.getElementById(id).classList.remove("hidden");
  }

  function backToStart() {
    showScreen("screen-start");
  }

  function goToSetup() {
    showScreen("screen-setup");
  }

  function refreshPlayerNameInputs() {
    const numSel    = document.getElementById("selectPlayers");
    const container = document.getElementById("playerNamesContainer");
    const n         = parseInt(numSel.value, 10);

    container.innerHTML = "";

    for (let i = 1; i <= n; i++) {
      const row = document.createElement("div");
      row.className = "player-row";

      const nameInput = document.createElement("input");
      nameInput.type = "text";
      nameInput.placeholder = "Jugador " + i;
      nameInput.id = "playerName" + i;

      const avatarSelect = document.createElement("select");
      avatarSelect.id = "playerAvatar" + i;

      for (let a = 1; a <= AVATAR_COUNT; a++) {
        const opt = document.createElement("option");
        opt.value = String(a);
        opt.textContent = "Avatar " + a;
        avatarSelect.appendChild(opt);
      }

      row.appendChild(nameInput);
      row.appendChild(avatarSelect);
      container.appendChild(row);
    }
  }

  function drawWord(categoryKey) {
    const deckKey = categoryKey === "aleatorio" ? "all" : categoryKey;

    if (!decksByCategory[deckKey] || decksByCategory[deckKey].length === 0) {
      alert(
        deckKey === "all"
          ? "Se han usado todas las palabras. Se reinicia el pack completo."
          : "Se han usado todas las palabras de la categoría \"" + deckKey + "\". Se reinicia esa categoría."
      );

      if (deckKey === "all") {
        decksByCategory.all = Object.values(categories).flat();
        shuffle(decksByCategory.all);
      } else {
        decksByCategory[deckKey] = [...categories[deckKey]];
        shuffle(decksByCategory[deckKey]);
      }
    }

    const deck = decksByCategory[deckKey];
    const idx  = Math.floor(Math.random() * deck.length);
    return deck.splice(idx, 1)[0];
  }

  function buildRandomOrder() {
    const arr = [];
    for (let i = 1; i <= gameState.numPlayers; i++) arr.push(i);
    shuffle(arr);
    gameState.ordenRonda = arr;
    console.log("Orden aleatorio de la ronda:", arr);
  }

  function avatarSrcFromIndex(idx) {
    const n = ((idx - 1 + AVATAR_COUNT) % AVATAR_COUNT) + 1;
    return "img/avatars/avatar" + n + ".png";
  }

  function startGame() {
    const numSel = document.getElementById("selectPlayers");
    const catSel = document.getElementById("selectCategory");

    gameState.numPlayers       = parseInt(numSel.value, 10);
    gameState.selectedCategory = catSel.value;

    gameState.playerNames = [];
    gameState.playerAvatars = [];

    for (let i = 1; i <= gameState.numPlayers; i++) {
      const input = document.getElementById("playerName" + i);
      const avatarSelect = document.getElementById("playerAvatar" + i);

      const name =
        (input && input.value.trim()) || "Jugador " + i;
      const avatarIndex =
        (avatarSelect && parseInt(avatarSelect.value, 10)) || i;

      gameState.playerNames.push(name);
      gameState.playerAvatars.push(avatarIndex);
    }

    const card = drawWord(gameState.selectedCategory);
    gameState.secretWord = card.word;
    gameState.secretHint = card.hint || "";

    gameState.impostorIndex =
      Math.floor(Math.random() * gameState.numPlayers) + 1;

    buildRandomOrder();
    gameState.currentPlayer = 1;

    prepareCurrentPlayerScreen();
    showScreen("screen-role");
  }

  function startAnotherRound() {
    const card = drawWord(gameState.selectedCategory);
    gameState.secretWord = card.word;
    gameState.secretHint = card.hint || "";

    gameState.impostorIndex =
      Math.floor(Math.random() * gameState.numPlayers) + 1;

    buildRandomOrder();
    gameState.currentPlayer = 1;

    prepareCurrentPlayerScreen();
    showScreen("screen-role");
  }

  const cardFrontEl = document.getElementById("cardFront");
  const nextBtnEl   = document.getElementById("nextPlayerBtn");
  const toggleRoleBtn = document.getElementById("toggleRoleBtn");
  const instructionTextEl = document.getElementById("roleInstructionText");

  let dragStartY = 0;
  let dragging   = false;
  let cardHeight = 0;
  let cardLiftedByButton = false;

  function prepareCurrentPlayerScreen() {
    const orderBadge = document.getElementById("playerOrder");
    const roleTitle  = document.getElementById("roleTitle");
    const roleWord   = document.getElementById("roleWord");
    const roleTip    = document.getElementById("roleTip");

    const turnIndex = gameState.currentPlayer;

    const realPlayer =
      gameState.ordenRonda && gameState.ordenRonda.length === gameState.numPlayers
        ? gameState.ordenRonda[turnIndex - 1]
        : turnIndex;

    const idx = realPlayer - 1;
    const isImpostor = realPlayer === gameState.impostorIndex;

    const name =
      gameState.playerNames[idx] || "Jugador " + realPlayer;

    const bigNameEl = document.getElementById("playerNameBig");
    if (bigNameEl) bigNameEl.textContent = name;

    const avatarIndex =
      gameState.playerAvatars[idx] ||
      ((idx % AVATAR_COUNT) + 1);

    const avatarEl = document.getElementById("frontAvatar");
    if (avatarEl) {
      avatarEl.src = avatarSrcFromIndex(avatarIndex);
    }

    if (orderBadge) {
      orderBadge.textContent = turnIndex + " de " + gameState.numPlayers;
    }

    if (isImpostor) {
      roleTitle.textContent = "Impostorcillo";
      roleWord.textContent  = "???";
      roleTip.textContent   =
        "No conoces la palabra secreta. Escucha y finge normalidad.";
    } else {
      roleTitle.textContent = "Ciudadano";
      roleWord.textContent  = "\"" + gameState.secretWord + "\"";
      roleTip.textContent   =
        gameState.secretHint || "Da pistas sin decir la palabra directamente.";
    }

    gameState.roleShown = false;
    cardFrontEl.style.transform = "translateY(0)";
    cardLiftedByButton = false;

    if (nextBtnEl) {
      nextBtnEl.style.display = "none";
      nextBtnEl.classList.remove("active");
    }

    if (toggleRoleBtn) {
      toggleRoleBtn.textContent = "Mostrar rol";
    }

    if (instructionTextEl) {
      instructionTextEl.innerHTML = isTouch
        ? "Desliza hacia arriba para ver tu rol.<br>Suelta para que la carta baje."
        : "Pulsa el botón para mostrar u ocultar tu rol.";
    }
  }

  function nextPlayer() {
    if (nextBtnEl) {
      nextBtnEl.style.display = "none";
      nextBtnEl.classList.remove("active");
    }

    gameState.currentPlayer++;

    if (gameState.currentPlayer > gameState.numPlayers) {
      showScreen("screen-debate");
      return;
    }

    prepareCurrentPlayerScreen();
    showScreen("screen-role");
  }

  function prepareRevealScreen() {
    document.getElementById("finalWord").textContent = gameState.secretWord;

    const impostorName =
      gameState.playerNames[gameState.impostorIndex - 1] ||
      "Jugador " + gameState.impostorIndex;

    document.getElementById("impostorPlayer").textContent = impostorName;
  }

  function onTouchStart(e) {
    if (!isTouch) return;

    const slider = cardFrontEl.parentElement;
    cardHeight   = slider.offsetHeight || 300;

    dragStartY = e.touches[0].clientY;
    dragging   = true;
    cardFrontEl.style.transition = "none";
  }

  function onTouchMove(e) {
    if (!dragging || !isTouch) return;

    const currentY = e.touches[0].clientY;
    let delta = currentY - dragStartY;

    if (delta > 0) delta = 0;
    if (delta < -cardHeight) delta = -cardHeight;

    cardFrontEl.style.transform = "translateY(" + delta + "px)";

    if (delta < -cardHeight / 3 && !gameState.roleShown) {
      gameState.roleShown = true;
      if (nextBtnEl) {
        nextBtnEl.style.display = "block";
        nextBtnEl.classList.add("active");
      }
    }
  }

  function onTouchEnd() {
    if (!dragging || !isTouch) return;
    dragging = false;

    cardFrontEl.style.transition = "transform 0.25s ease";
    cardFrontEl.style.transform = "translateY(0)";

    setTimeout(() => {
      cardFrontEl.style.transition = "";
    }, 250);
  }

  if (isTouch) {
    cardFrontEl.addEventListener("touchstart", onTouchStart, { passive: true });
    cardFrontEl.addEventListener("touchmove", onTouchMove, { passive: true });
    cardFrontEl.addEventListener("touchend", onTouchEnd);
  }

  if (!isTouch && toggleRoleBtn) {
    toggleRoleBtn.style.display = "block";

    toggleRoleBtn.addEventListener("click", () => {
      const slider = cardFrontEl.parentElement;
      const h = slider.offsetHeight || 300;

      if (!cardLiftedByButton) {
        cardFrontEl.style.transition = "transform 0.25s ease";
        cardFrontEl.style.transform = "translateY(" + (-h * 0.7) + "px)";

        setTimeout(() => {
          cardFrontEl.style.transition = "";
        }, 260);

        if (!gameState.roleShown) {
          gameState.roleShown = true;
          if (nextBtnEl) {
            nextBtnEl.style.display = "block";
            nextBtnEl.classList.add("active");
          }
        }

        toggleRoleBtn.textContent = "Ocultar rol";
        cardLiftedByButton = true;
      } else {
        cardFrontEl.style.transition = "transform 0.25s ease";
        cardFrontEl.style.transform = "translateY(0)";

        setTimeout(() => {
          cardFrontEl.style.transition = "";
        }, 260);

        toggleRoleBtn.textContent = "Mostrar rol";
        cardLiftedByButton = false;
      }
    });
  }

  if (nextBtnEl) {
    nextBtnEl.addEventListener("click", nextPlayer);
  }

  document.getElementById("btnGoReveal").addEventListener("click", () => {
    prepareRevealScreen();
    showScreen("screen-reveal");
  });

  document.getElementById("selectPlayers")
    .addEventListener("change", refreshPlayerNameInputs);

  (function init() {
    const versionEl = document.getElementById("versionLabel");
    if (versionEl) {
      versionEl.textContent = "Versión " + APP_VERSION;
    }
    refreshPlayerNameInputs();
    loadWordsFromCsv();
    showScreen("screen-start");
  })();
  </script>
</body>
</html>
