<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>El Impostorcillo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    * {
      box-sizing: border-box;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    body {
      margin: 0;
      background: #050816;
      color: #f5f5f5;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
    }

    .app {
      width: 100%;
      max-width: 480px;
      padding: 16px;
    }

    .card {
      background: #111827;
      border-radius: 16px;
      padding: 20px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.4);
    }

    h1, h2, h3 {
      margin-top: 0;
      text-align: center;
    }

    h1 {
      font-size: 1.9rem;
      margin-bottom: 0.5rem;
    }

    p {
      line-height: 1.4;
    }

    label {
      display: block;
      margin: 10px 0 4px;
      font-size: 0.9rem;
      opacity: 0.9;
    }

    input, select {
      width: 100%;
      padding: 8px 10px;
      border-radius: 8px;
      border: none;
      font-size: 1rem;
      margin-bottom: 8px;
    }

    button {
      width: 100%;
      padding: 12px;
      border-radius: 999px;
      border: none;
      font-size: 1rem;
      font-weight: 600;
      margin-top: 14px;
      cursor: pointer;
      background: linear-gradient(135deg, #22c55e, #16a34a);
      color: #fff;
      box-shadow: 0 6px 16px rgba(22, 163, 74, 0.5);
      transition: transform 0.1s ease, box-shadow 0.1s ease, opacity 0.15s ease;
    }

    button.secondary {
      background: #374151;
      box-shadow: none;
    }

    button:active {
      transform: translateY(1px);
      box-shadow: 0 3px 8px rgba(22, 163, 74, 0.4);
      opacity: 0.9;
    }

    .small {
      font-size: 0.85rem;
      text-align: center;
      opacity: 0.8;
      margin-top: 12px;
    }

    .hidden {
      display: none;
    }

    .big-word {
      font-size: 1.8rem;
      text-align: center;
      margin: 20px 0;
      word-wrap: break-word;
    }

    .role-text {
      font-size: 1.1rem;
      text-align: center;
      margin-top: 10px;
      min-height: 3em;
    }

    .badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      background: #1f2937;
      color: #9ca3af;
      margin-bottom: 10px;
    }

    .center {
      text-align: center;
    }

    .highlight {
      color: #22c55e;
      font-weight: 700;
    }
  </style>
</head>
<body>
  <div class="app">
    <div class="card">
      <!-- Pantalla: Inicio -->
      <div id="screen-start">
        <h1>El Impostorcillo</h1>
        <p class="center">
          Juego de pistas para jugar en grupo.<br/>
          Pasa el m√≥vil de mano en mano, improvisad pistas<br/>
          y descubrid qui√©n estaba fingiendo.
        </p>
        <button onclick="goToSetup()">Nueva partida</button>
        <p class="small">Consejo: pon el m√≥vil en silencio para que nadie vea notificaciones chivatas üòè</p>
      </div>

      <!-- Pantalla: Configuraci√≥n -->
      <div id="screen-setup" class="hidden">
        <h2>Configuraci√≥n</h2>

        <label for="numPlayers">N√∫mero de jugadores</label>
        <input type="number" id="numPlayers" min="3" max="12" value="5" />

        <label for="category">Categor√≠a</label>
        <select id="category">
          <option value="random">Aleatorio</option>
          <option value="comida">Comida</option>
          <option value="sitios">Lugares</option>
          <option value="peliculas">Pel√≠culas</option>
          <option value="objetos">Objetos</option>
        </select>

        <button onclick="startGame()">Empezar</button>
        <button class="secondary" onclick="backToStart()">Volver</button>

        <p class="small">Modo actual: 1 solo Impostorcillo, votos y acusaciones se hacen de viva voz.</p>
      </div>

      <!-- Pantalla: Rol de jugador -->
      <div id="screen-role" class="hidden">
        <div class="center">
          <span class="badge" id="playerBadge"></span>
        </div>
        <h2 id="roleTitle">Tu rol</h2>

        <p class="role-text" id="roleDescription">
          Cuando est√©s <strong>solo</strong> y nadie mire la pantalla,<br/>
          pulsa el bot√≥n de abajo para ver tu rol.
        </p>

        <div class="big-word" id="wordDisplay"></div>

        <p class="small">
          Primero pulsa <strong>‚ÄúMostrar rol‚Äù</strong> cuando est√©s solo.<br/>
          Despu√©s, pulsa <strong>‚ÄúListo, pasa el m√≥vil‚Äù</strong> y entr√©gaselo al siguiente jugador.
        </p>

        <button id="btnShowRole" onclick="showPlayerRole()">Mostrar rol</button>
        <button id="btnNextPlayer" class="secondary hidden" onclick="nextPlayer()">Listo, pasa el m√≥vil</button>
      </div>

      <!-- Pantalla: Debate / votaci√≥n -->
      <div id="screen-vote" class="hidden">
        <h2>Debatid y votad</h2>
        <p class="center">
          Todos hab√©is visto ya vuestro rol.<br/><br/>
          Ahora:
        </p>
        <ul style="font-size:0.95rem; line-height:1.5;">
          <li>Dad una pista cada uno, sin decir la palabra.</li>
          <li>Comentad y acusad a quien cre√°is que es el Impostorcillo.</li>
          <li>Haced una votaci√≥n final.</li>
        </ul>
        <p class="small">
          Cuando teng√°is decidido qui√©n es el Impostorcillo,<br/>
          pulsad el bot√≥n de abajo para ver el resultado real.
        </p>
        <button onclick="revealRoles()">Revelar resultado</button>
      </div>

      <!-- Pantalla: Revelaci√≥n final -->
      <div id="screen-reveal" class="hidden">
        <h2>Revelaci√≥n</h2>
        <p class="center">La palabra secreta era:</p>
        <div class="big-word" id="finalWord"></div>
        <p class="center">
          El Impostorcillo era el <span class="highlight" id="impostorPlayer"></span>.
        </p>
        <p class="small">
          ¬øHab√©is acertado? ¬øO el Impostorcillo os ha liado a todos? üòà
        </p>
        <button onclick="goToSetup()">Jugar otra vez</button>
        <button class="secondary" onclick="backToStart()">Salir al inicio</button>
      </div>
    </div>
  </div>

<script>
  // ==============================
  // BASE DE DATOS (JSON externo)
  // ==============================

  let WORDS_DB = [];
  let unusedWords = []; // baraja de palabras que a√∫n no han salido

  // Mezcla un array (Fisher-Yates)
  function shuffle(array) {
    for (let i = array.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [array[i], array[j]] = [array[j], array[i]];
    }
  }

  // Inicializa la baraja con todas las palabras disponibles
  function initDeck() {
    if (!WORDS_DB || WORDS_DB.length === 0) return;
    unusedWords = WORDS_DB.filter(item => item.type === "word");
    shuffle(unusedWords);
    console.log("Baraja reiniciada con", unusedWords.length, "palabras.");
  }

  async function loadWordsDb() {
    try {
      const res = await fetch('data/words-es.json');
      if (!res.ok) throw new Error('No se pudo cargar data/words-es.json');
      const data = await res.json();
      if (Array.isArray(data)) {
        WORDS_DB = data;
        console.log('Base de datos de palabras cargada:', WORDS_DB.length, 'entradas');
        initDeck(); // creamos la baraja al cargar
      } else {
        console.error('El JSON de palabras no es un array');
      }
    } catch (err) {
      console.error('Error cargando base de datos de palabras:', err);
    }
  }

  // Cargamos la base nada m√°s abrir la p√°gina
  loadWordsDb();

  // ==============================
  // ESTADO DEL JUEGO
  // ==============================

  let gameState = {
    numPlayers: 0,
    currentPlayer: 1,
    secretWord: "",
    impostorIndex: 1,
    roleShown: false  // controla si el jugador ya ha visto su rol
  };

  // ==============================
  // UTILIDADES
  // ==============================

  function showScreen(id) {
    document.getElementById("screen-start").classList.add("hidden");
    document.getElementById("screen-setup").classList.add("hidden");
    document.getElementById("screen-role").classList.add("hidden");
    document.getElementById("screen-vote").classList.add("hidden");
    document.getElementById("screen-reveal").classList.add("hidden");
    document.getElementById(id).classList.remove("hidden");
  }

  function backToStart() {
    showScreen("screen-start");
  }

  function goToSetup() {
    showScreen("screen-setup");
  }

  function getRandomFromArray(arr) {
    return arr[Math.floor(Math.random() * arr.length)];
  }

  // Devuelve una palabra de la baraja (sin repetir en la sesi√≥n)
  function getRandomWord(categoryKey) {
    // Si a√∫n no se ha cargado la base, devolvemos algo gen√©rico
    if (!WORDS_DB || WORDS_DB.length === 0) {
      const fallback = ["Impostor", "Misterio", "Secreto", "Sombra"];
      return getRandomFromArray(fallback);
    }

    // Si la baraja est√° vac√≠a, reiniciamos
    if (!unusedWords || unusedWords.length === 0) {
      alert("Se han usado todas las palabras disponibles. Se reinicia la baraja para seguir jugando.");
      initDeck();
    }

    let pool = unusedWords;

    // Si se ha elegido categor√≠a concreta, intentamos respetarla
    if (categoryKey && categoryKey !== "random") {
      const filtered = pool.filter(item => item.category === categoryKey);
      if (filtered.length > 0) {
        pool = filtered;
      }
      // Si no hay ninguna palabra de esa categor√≠a en la baraja,
      // usamos el pool completo para no romper la partida.
    }

    if (pool.length === 0) {
      // Caso extremo: algo raro ha pasado, reiniciamos baraja
      initDeck();
      pool = unusedWords;
    }

    // Elegimos una palabra del pool
    const chosen = getRandomFromArray(pool);

    // Quitamos esa palabra de la baraja global para que no se repita en esta sesi√≥n
    unusedWords = unusedWords.filter(item => item.id !== chosen.id);

    return chosen.text;
  }

  // ==============================
  // L√ìGICA PRINCIPAL
  // ==============================

  function startGame() {
    const numPlayersInput = document.getElementById("numPlayers");
    const categorySelect = document.getElementById("category");

    let n = parseInt(numPlayersInput.value, 10);
    if (isNaN(n) || n < 3) n = 3;
    if (n > 12) n = 12;

    const cat = categorySelect.value;

    gameState.numPlayers = n;
    gameState.currentPlayer = 1;
    gameState.secretWord = getRandomWord(cat);
    gameState.impostorIndex = Math.floor(Math.random() * n) + 1;
    gameState.roleShown = false;

    preparePlayerNeutralScreen();
    showScreen("screen-role");
  }

  // Pantalla neutra para el jugador actual (sin mostrar todav√≠a su rol)
  function preparePlayerNeutralScreen() {
    const { currentPlayer, numPlayers } = gameState;

    const badge = document.getElementById("playerBadge");
    const roleTitle = document.getElementById("roleTitle");
    const roleDescription = document.getElementById("roleDescription");
    const wordDisplay = document.getElementById("wordDisplay");
    const btnShowRole = document.getElementById("btnShowRole");
    const btnNextPlayer = document.getElementById("btnNextPlayer");

    gameState.roleShown = false;

    badge.textContent = `Jugador ${currentPlayer} de ${numPlayers}`;
    roleTitle.textContent = "Tu rol";
    roleDescription.innerHTML =
      'Cuando est√©s <strong>solo</strong> y nadie mire la pantalla,<br/>pulsa el bot√≥n de abajo para ver tu rol.';

    wordDisplay.textContent = "";
    btnShowRole.classList.remove("hidden");
    btnNextPlayer.classList.add("hidden");
  }

  // Se llama cuando el jugador pulsa "Mostrar rol"
  function showPlayerRole() {
    const { currentPlayer, impostorIndex, secretWord } = gameState;

    const roleTitle = document.getElementById("roleTitle");
    const roleDescription = document.getElementById("roleDescription");
    const wordDisplay = document.getElementById("wordDisplay");
    const btnShowRole = document.getElementById("btnShowRole");
    const btnNextPlayer = document.getElementById("btnNextPlayer");

    if (currentPlayer === impostorIndex) {
      roleTitle.textContent = "Eres el Impostorcillo üòà";
      roleDescription.textContent =
        "No conoces la palabra secreta. Escucha las pistas de los dem√°s, improvisa y finge que t√∫ tambi√©n la sabes.";
      wordDisplay.textContent = "???";
    } else {
      roleTitle.textContent = "Eres ciudadano üë§";
      roleDescription.textContent =
        "Conoces la palabra secreta. Da pistas sin decirla directamente, pero sin que te confundan con el Impostorcillo.";
      wordDisplay.textContent = secretWord;
    }

    gameState.roleShown = true;

    btnShowRole.classList.add("hidden");
    btnNextPlayer.classList.remove("hidden");
  }

  function nextPlayer() {
    if (!gameState.roleShown) return;

    if (gameState.currentPlayer < gameState.numPlayers) {
      gameState.currentPlayer += 1;
      preparePlayerNeutralScreen();
      showScreen("screen-role");
    } else {
      showScreen("screen-vote");
    }
  }

  function revealRoles() {
    document.getElementById("finalWord").textContent = gameState.secretWord;
    document.getElementById("impostorPlayer").textContent = `Jugador ${gameState.impostorIndex}`;
    showScreen("screen-reveal");
  }
</script>
</body>
</html>
