<!DOCTYPE html>

<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>El Impostorcillo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />

  <style>
  * {
    box-sizing: border-box;
    font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
  }

  body {
    margin: 0;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
    background-attachment: fixed;
    color: #1f2937;
    display: flex;
    justify-content: center;
    align-items: center;
    min-height: 100vh;
    padding: 20px 0;
  }

  .app {
    width: 100%;
    max-width: 480px;
    padding: 16px;
  }

  .card {
    background: rgba(255, 255, 255, 0.98);
    border-radius: 24px;
    padding: 32px 24px 28px;
    box-shadow: 0 25px 50px rgba(0, 0, 0, 0.25), 0 10px 20px rgba(0, 0, 0, 0.15);
    position: relative;
    backdrop-filter: blur(20px);
    border: 2px solid rgba(255, 255, 255, 0.5);
  }

  .screen.hidden {
    display: none;
  }

  h1, h2, h3 {
    margin-top: 0;
    text-align: center;
    color: #1f2937;
  }

  h1 {
    font-size: 2.2rem;
    margin-bottom: 0.5rem;
    background: linear-gradient(135deg, #667eea, #764ba2);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    font-weight: 800;
  }

  h2 {
    font-size: 1.8rem;
    font-weight: 700;
  }

  p {
    line-height: 1.6;
    color: #4b5563;
  }

  label {
    display: block;
    margin: 16px 0 6px;
    font-size: 0.95rem;
    font-weight: 600;
    color: #374151;
  }

  input, select {
    width: 100%;
    padding: 12px 14px;
    border-radius: 12px;
    border: 2px solid #e5e7eb;
    font-size: 1rem;
    margin-bottom: 8px;
    background: white;
    transition: all 0.2s ease;
  }

  input:focus, select:focus {
    outline: none;
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
  }

  /* Botones */
  button {
    width: 100%;
    padding: 14px;
    border-radius: 16px;
    border: none;
    font-size: 1.05rem;
    font-weight: 700;
    margin-top: 16px;
    cursor: pointer;
    background: linear-gradient(135deg, #667eea, #764ba2);
    color: #fff;
    box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
    transition: all 0.2s ease;
    position: relative;
    overflow: hidden;
  }

  button::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
    transition: left 0.5s ease;
  }

  button:hover::before {
    left: 100%;
  }

  button:hover {
    transform: translateY(-2px);
    box-shadow: 0 12px 28px rgba(102, 126, 234, 0.5);
  }

  button.secondary {
    background: linear-gradient(135deg, #6b7280, #4b5563);
    box-shadow: 0 4px 12px rgba(75, 85, 99, 0.3);
  }

  button.secondary:hover {
    box-shadow: 0 8px 20px rgba(75, 85, 99, 0.4);
  }

  button:active {
    transform: translateY(0);
  }

  .small {
    font-size: 0.9rem;
    text-align: center;
    color: #6b7280;
    margin-top: 16px;
    line-height: 1.5;
  }

  .version-label {
    margin-top: 12px;
    font-size: 0.85rem;
    color: #9ca3af;
  }

  .badge {
    display: inline-block;
    padding: 6px 16px;
    border-radius: 999px;
    font-size: 0.8rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    background: linear-gradient(135deg, #667eea, #764ba2);
    color: white;
    margin-bottom: 12px;
    font-weight: 600;
    box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
  }

  .center {
    text-align: center;
  }

  .highlight {
    color: #764ba2;
    font-weight: 700;
    font-size: 1.2em;
  }

  /* Botón pequeño menú */
  .menu-button {
    position: absolute;
    top: -16px;
    right: -16px;
    width: 44px;
    height: 44px;
    border-radius: 50%;
    border: none;
    cursor: pointer;
    background: linear-gradient(135deg, #667eea, #764ba2);
    color: white;
    font-size: 1.2rem;
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.5);
    padding: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    width: 44px !important;
    z-index: 10;
    transition: all 0.2s ease;
  }

  .menu-button:hover {
    transform: scale(1.1) rotate(90deg);
    box-shadow: 0 6px 16px rgba(102, 126, 234, 0.6);
  }

  .menu-button span {
    pointer-events: none;
  }

  /* Inicio */
  .hero-illustration {
    display: flex;
    justify-content: center;
    margin-bottom: 20px;
    animation: float 3s ease-in-out infinite;
  }

  @keyframes float {
    0%, 100% { transform: translateY(0px); }
    50% { transform: translateY(-10px); }
  }

  .hero-illustration img {
    width: 80%;
    max-width: 260px;
    border-radius: 24px;
    box-shadow: 0 15px 35px rgba(0,0,0,0.2);
  }

  /* Configuración */
  .title-row {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 12px;
    margin-bottom: 8px;
  }

  .title-icon {
    width: 64px;
    height: 64px;
    border-radius: 50%;
    box-shadow: 0 6px 16px rgba(102, 126, 234, 0.4);
    animation: pulse 2s ease-in-out infinite;
  }

  @keyframes pulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.05); }
  }

  /* Fila de configuración de jugador */
  .player-row {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 12px;
  }

  .player-row input {
    flex: 1;
    margin-bottom: 0;
  }

  /* Avatar pequeño para elegir en la configuración */
  .avatar-thumb {
    width: 48px;
    height: 48px;
    border-radius: 50%;
    object-fit: cover;
    border: 3px solid #e5e7eb;
    cursor: pointer;
    box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    transition: all 0.2s ease;
  }

  .avatar-thumb:hover {
    transform: scale(1.15);
    box-shadow: 0 6px 16px rgba(102, 126, 234, 0.5);
    border-color: #667eea;
  }

  .avatar-thumb:active {
    transform: scale(1.05);
  }

  /* Badge del rol */
  .role-badge-row .badge {
    background: linear-gradient(135deg, #f093fb, #f5576c);
    box-shadow: 0 2px 8px rgba(245, 87, 108, 0.3);
  }

  /* Carta deslizable contenedor */
  .card-slider {
    width: 100%;
    height: 400px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 28px;
    overflow: hidden;
    position: relative;
    touch-action: none;
    box-shadow: 0 15px 40px rgba(0,0,0,0.3);
    margin-bottom: 20px;
    border: 3px solid rgba(255, 255, 255, 0.3);
  }

  .card-back,
  .card-front {
    position: absolute;
    inset: 12px;
    border-radius: 24px;
    box-shadow: 0 12px 30px rgba(0,0,0,0.25);
    overflow: hidden;
    background: transparent;
  }

  /* Marco ilustrado de la carta (frontal y trasera) */
  .card-frame-img {
    position: absolute;
    inset: 0;
    width: 100%;
    height: 100%;
    object-fit: contain;
    pointer-events: none;
    z-index: 1;
  }

  /* Contenido del rol sobre el pergamino */
  .card-back-content {
    position: absolute;
    top: 65%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 72%;
    text-align: center;
    color: #111827;
    z-index: 2;
  }

  #roleTitle {
    font-size: 1.7rem;
    margin-bottom: 10px;
    color: #111827;
    font-weight: 700;
  }

  #roleWord {
    font-size: 2rem;
    font-weight: 900;
    color: #111827;
    margin-bottom: 12px;
    word-wrap: break-word;
  }

  .role-tip {
    font-size: 1rem;
    color: #4b5563;
    max-width: 100%;
    line-height: 1.4;
  }

  /* Avatar centrado tapando el agujero */
  .avatar-overlay {
    position: absolute;
    top: 30%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 54%;
    aspect-ratio: 1 / 1;
    z-index: 2;
    display: flex;
    align-items: center;
    justify-content: center;
    pointer-events: none;
  }

  .avatar-overlay img {
    width: 100%;
    height: 100%;
    border-radius: 50%;
    object-fit: cover;
    box-shadow: 0 8px 20px rgba(0,0,0,0.3);
    border: 4px solid rgba(255, 255, 255, 0.9);
  }

  /* Texto de instrucciones en la parte inferior de la carta frontal */
  .slide-text {
    position: absolute;
    bottom: 14%;
    left: 50%;
    transform: translateX(-50%);
    width: 72%;
    text-align: center;
    font-size: 1rem;
    margin: 0;
    color: #111827;
    font-weight: 700;
    text-shadow: 0 2px 4px rgba(255,255,255,0.8);
    z-index: 2;
  }

  /* Botón "Jugador siguiente" */
  #nextPlayerBtn {
    background: linear-gradient(135deg, #d1d5db, #9ca3af);
    color: #6b7280;
    opacity: 0.6;
    border-radius: 16px;
    padding: 16px 28px;
    font-size: 1.1rem;
    border: none;
    width: 90%;
    max-width: 340px;
    margin: 24px auto 0;
    display: block;
    box-shadow: none;
    transition: all 0.3s ease;
  }

  #nextPlayerBtn.active {
    background: linear-gradient(135deg, #10b981, #059669);
    color: #ffffff;
    opacity: 1;
    box-shadow: 0 8px 20px rgba(16, 185, 129, 0.4);
    animation: bounce 0.5s ease;
  }

  @keyframes bounce {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-5px); }
  }

  #nextPlayerBtn.active:hover {
    transform: translateY(-2px);
    box-shadow: 0 12px 28px rgba(16, 185, 129, 0.5);
  }

  /* Nombre del jugador grande arriba */
  .player-name-big {
    font-size: 2rem;
    font-weight: 900;
    text-align: center;
    margin: 0 0 16px 0;
    background: linear-gradient(135deg, #667eea, #764ba2);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    letter-spacing: 1px;
    text-transform: uppercase;
  }

  /* Lista mejorada */
  ul {
    font-size: 1rem;
    line-height: 1.7;
    color: #4b5563;
    padding-left: 24px;
  }

  ul li {
    margin-bottom: 8px;
  }

  /* Palabra final revelada */
  #finalWord {
    font-size: 2.2rem;
    text-align: center;
    margin: 16px 0;
    font-weight: 900;
    background: linear-gradient(135deg, #667eea, #764ba2);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    padding: 12px;
    border-radius: 16px;
    background-color: rgba(102, 126, 234, 0.1);
  }

  /* Información del jugador inicial */
  #starterInfo {
    font-size: 1.2rem;
    margin-top: 12px;
    font-weight: 600;
    color: #374151;
  }

  /* Animación de entrada para las pantallas */
  .screen {
    animation: fadeIn 0.3s ease;
  }

  @keyframes fadeIn {
    from {
      opacity: 0;
      transform: translateY(10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  /* Mejora del botón toggle role */
  #toggleRoleBtn {
    background: linear-gradient(135deg, #667eea, #764ba2);
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
    color: white;
  }

  #toggleRoleBtn:hover {
    box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
  }
  </style>

</head>
<body>
  <div class="app">
    <div class="card">

```
  <!-- botón de menú global -->
  <button class="menu-button" onclick="goToSetup()">
    <span>≡</span>
  </button>

  <!-- PANTALLA: INICIO -->
  <div id="screen-start" class="screen">
    <div class="hero-illustration">
      <img src="img/impostor-hero.png" alt="Impostorcillo">
    </div>

    <h1>El Impostorcillo</h1>
    <p class="center">
      El juego social de deducción y engaño.<br>
      ¡Intenta no parecer sospechoso!
    </p>

    <button onclick="goToSetup()">Nueva partida</button>
    <p id="appVersion" class="small version-label"></p>
  </div>

  <!-- PANTALLA: CONFIGURACIÓN -->
  <div id="screen-setup" class="screen hidden">

    <div class="title-row">
      <img src="img/impostor-icon.png" class="title-icon">
      <h2>Configuración</h2>
    </div>

    <label for="selectPlayers">Número de jugadores</label>
    <select id="selectPlayers">
      <option value="3" selected>3 jugadores</option>
      <option value="4">4 jugadores</option>
      <option value="5">5 jugadores</option>
      <option value="6">6 jugadores</option>
      <option value="7">7 jugadores</option>
      <option value="8">8 jugadores</option>
      <option value="9">9 jugadores</option>
      <option value="10">10 jugadores</option>
    </select>

    <label>Nombre de los jugadores y avatar</label>
    <div id="playerNamesContainer"></div>

    <label for="selectCategory">Categoría</label>
    <select id="selectCategory">
      <option value="aleatorio">Aleatorio</option>
      <option value="comida">Comida</option>
      <option value="animales">Animales</option>
      <option value="objetos">Objetos</option>
      <option value="sitios">Sitios</option>
      <option value="deportes">Deportes</option>
      <option value="videojuegos">Videojuegos</option>
      <option value="transportes">Transportes</option>
    </select>

    <button onclick="startGame()">Empezar</button>
    <button class="secondary" onclick="backToStart()">Volver</button>

    <p class="small">
      Modo: 1 Impostorcillo por ronda. Las acusaciones se hacen hablando.
    </p>

  </div>

  <!-- PANTALLA: ROL DEL JUGADOR -->
  <div id="screen-role" class="screen hidden">

    <div class="role-badge-row">
      <span class="badge" id="playerOrder"></span>
    </div>
    <h2 id="playerNameBig" class="player-name-big"></h2>

    <div class="card-slider">
      <!-- Parte trasera: el rol con pergamino -->
      <div class="card-back">
        <img src="img/card-frame-back.png" class="card-frame-img" alt="Carta de rol">
        <div class="card-back-content">
          <h3 id="roleTitle"></h3>
          <div id="roleWord"></div>
          <p class="role-tip" id="roleTip"></p>
        </div>
      </div>

      <!-- Parte frontal: marco cuero + avatar + texto deslizar -->
      <div class="card-front" id="cardFront">
        <img src="img/card-frame-front.png" class="card-frame-img" alt="Carta frontal">
        <div class="avatar-overlay">
          <img id="frontAvatar" src="img/avatar1.png" alt="avatar del jugador">
        </div>
        <p class="slide-text">Desliza hacia arriba para ver tu rol</p>
      </div>
    </div>

    <p id="instructionText" class="small"></p>

    <!-- Botón alternativo para ratón / dispositivos sin touch -->
    <button id="toggleRoleBtn" class="secondary" style="width:90%;max-width:340px;margin:10px auto 0;display:block;">
      Mostrar rol
    </button>

    <button id="nextPlayerBtn" class="secondary hidden" onclick="nextPlayer()">
      Jugador siguiente
    </button>
  </div>

  <!-- PANTALLA: DEBATE -->
  <div id="screen-debate" class="screen hidden">
    <h2>Debatid y votad</h2>
    <p id="starterInfo" class="center"></p>
    <p class="center">
      Todos han visto ya su rol.<br><br>
      Ahora toca hablar:
    </p>

    <ul>
      <li>Cada jugador dice una pista sobre la palabra.</li>
      <li>Comentad, defendedos y acusad al sospechoso.</li>
      <li>Haced una votación final.</li>
    </ul>

    <button id="btnGoReveal">Ver resultado</button>
  </div>

  <!-- PANTALLA: REVELACIÓN -->
  <div id="screen-reveal" class="screen hidden">

    <h2>Revelación</h2>

    <p class="center">La palabra secreta era:</p>
    <div id="finalWord"></div>

    <p class="center">
      El Impostorcillo era<br>
      <span class="highlight" id="impostorPlayer"></span>
    </p>

    <button onclick="startAnotherRound()">Jugar otra ronda</button>
    <button class="secondary" onclick="backToStart()">Volver al inicio</button>
  </div>

</div>
```

  </div>

  <script>
  // ============================
  // CONFIG: ruta del CSV
  // ============================
  const APP_VERSION = "1.1.0";
  const CSV_URL = "data/words-es.csv?v=" + APP_VERSION;

  // Detectar si el dispositivo tiene pantalla táctil
  const isTouch = ('ontouchstart' in window || navigator.maxTouchPoints > 0);

  // Datos en memoria
  let categories = {};      // { categoria: [ {word, hint}, ... ] }
  let decksByCategory = {}; // barajas sin repetir
  let sheetLoaded = false;

  // Estado del juego
  const gameState = {
    numPlayers: 3,
    currentPlayer: 1,
    selectedCategory: "aleatorio",
    secretWord: "",
    secretHint: "",
    impostorIndex: 1,
    roleShown: false,
    playerNames: [],
    playerAvatars: [],
    ordenRonda: [],
    starterPlayer: 1
  };

  const MAX_AVATARS = 8; // avatar1.png ... avatar8.png

  // ============================
  // UTILIDADES
  // ============================
  function shuffle(arr) {
    for (let i = arr.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [arr[i], arr[j]] = [arr[j], arr[i]];
    }
  }

  // Convierte CSV a objetos
  function parseCsv(text) {
    const lines = text.split(/\r?\n/).filter(l => l.trim().length > 0);
    const [headerLine, ...rows] = lines;
    const headers = headerLine.split(",");

    const idxCategory = headers.indexOf("category");
    const idxWord     = headers.indexOf("word");
    const idxHint     = headers.indexOf("hint");

    const result = {};

    rows.forEach(line => {
      const parts = line.split(",");
      const cat   = parts[idxCategory]?.trim();
      const word  = parts[idxWord]?.trim();
      const hint  = parts[idxHint]?.trim();

      if (!cat || !word) return;

      if (!result[cat]) result[cat] = [];
      result[cat].push({
        word,
        hint: hint || ""
      });
    });

    return result;
  }

  // Lee CSV de GitHub Pages
  async function loadWordsFromCsv() {
    try {
      const res = await fetch(CSV_URL);
      if (!res.ok) throw new Error("No se pudo cargar el CSV");
      const csvText = await res.text();

      categories = parseCsv(csvText);
      decksByCategory = {};

      // Crear baraja por categoría
      Object.keys(categories).forEach(cat => {
        decksByCategory[cat] = [...categories[cat]];
        shuffle(decksByCategory[cat]);
      });

      // Baraja global "all"
      decksByCategory.all = Object.values(categories).flat();
      shuffle(decksByCategory.all);

      sheetLoaded = true;
      console.log("CSV cargado. Categorías:", Object.keys(categories));
    } catch (err) {
      console.error("Error cargando CSV:", err);
      sheetLoaded = false;
    }
  }

  // ============================
  // CAMBIO DE PANTALLAS
  // ============================
  function showScreen(id) {
    document.querySelectorAll(".screen").forEach(s => s.classList.add("hidden"));
    const el = document.getElementById(id);
    if (el) el.classList.remove("hidden");
  }

  function backToStart() {
    showScreen("screen-start");
  }

  function goToSetup() {
    showScreen("screen-setup");
  }

  // ============================
  // INPUTS DE NOMBRES + AVATARES
  // ============================
  function refreshPlayerNameInputs() {
    const numSel    = document.getElementById("selectPlayers");
    const container = document.getElementById("playerNamesContainer");
    const n         = parseInt(numSel.value, 10);

    container.innerHTML = "";
    gameState.playerAvatars = gameState.playerAvatars || [];

    for (let i = 1; i <= n; i++) {
      const row = document.createElement("div");
      row.className = "player-row";

      const input = document.createElement("input");
      input.type = "text";
      input.placeholder = `Jugador ${i}`;
      input.id = `playerName${i}`;

      const idxArr = i - 1;
      if (!gameState.playerAvatars[idxArr]) {
        gameState.playerAvatars[idxArr] = ((idxArr % MAX_AVATARS) + 1);
      }
      const avatarIndex = gameState.playerAvatars[idxArr];

      const avatarImg = document.createElement("img");
      avatarImg.className = "avatar-thumb";
      avatarImg.src = `img/avatar${avatarIndex}.png`;
      avatarImg.alt = `Avatar jugador ${i}`;
      avatarImg.dataset.playerIndex = idxArr;

      avatarImg.addEventListener("click", () => {
        cycleAvatar(idxArr, avatarImg);
      });

      row.appendChild(input);
      row.appendChild(avatarImg);
      container.appendChild(row);
    }
  }

  function cycleAvatar(playerIdx, imgEl) {
    let current = gameState.playerAvatars[playerIdx] || 1;
    let next = current + 1;
    if (next > MAX_AVATARS) next = 1;

    gameState.playerAvatars[playerIdx] = next;
    if (imgEl) {
      imgEl.src = `img/avatar${next}.png`;
    }
  }

  // ============================
  // SELECCIONAR PALABRA
  // ============================
  function drawWord(categoryKey) {
    const deckKey = categoryKey === "aleatorio" ? "all" : categoryKey;

    if (!decksByCategory[deckKey] || decksByCategory[deckKey].length === 0) {
      alert(
        deckKey === "all"
          ? "Se han usado todas las palabras. Se reinicia el pack completo."
          : `Se han usado todas las palabras de la categoría "${deckKey}". Se reinicia esa categoría.`
      );

      if (deckKey === "all") {
        decksByCategory.all = Object.values(categories).flat();
        shuffle(decksByCategory.all);
      } else {
        decksByCategory[deckKey] = [...categories[deckKey]];
        shuffle(decksByCategory[deckKey]);
      }
    }

    const deck = decksByCategory[deckKey];
    const idx  = Math.floor(Math.random() * deck.length);
    return deck.splice(idx, 1)[0];
  }

  // ============================
  // EMPEZAR PARTIDA
  // ============================
  function startGame() {
    const numSel = document.getElementById("selectPlayers");
    const catSel = document.getElementById("selectCategory");

    gameState.numPlayers       = parseInt(numSel.value, 10);
    gameState.selectedCategory = catSel.value;

    gameState.playerNames = [];
    for (let i = 1; i <= gameState.numPlayers; i++) {
      const input = document.getElementById(`playerName${i}`);
      const name  = (input && input.value.trim()) || `Jugador ${i}`;
      gameState.playerNames.push(name);
    }

    const card = drawWord(gameState.selectedCategory);
    gameState.secretWord = card.word;
    gameState.secretHint = card.hint || "";

    gameState.impostorIndex =
      Math.floor(Math.random() * gameState.numPlayers) + 1;

    gameState.starterPlayer =
      Math.floor(Math.random() * gameState.numPlayers) + 1;

    gameState.ordenRonda = [];
    for (let i = 1; i <= gameState.numPlayers; i++) {
      gameState.ordenRonda.push(i);
    }
    shuffle(gameState.ordenRonda);

    gameState.currentPlayer = 1;

    prepareCurrentPlayerScreen();
    showScreen("screen-role");
  }

  function startAnotherRound() {
    const card = drawWord(gameState.selectedCategory);
    gameState.secretWord = card.word;
    gameState.secretHint = card.hint || "";
    gameState.impostorIndex =
      Math.floor(Math.random() * gameState.numPlayers) + 1;

    gameState.starterPlayer =
      Math.floor(Math.random() * gameState.numPlayers) + 1;

    gameState.ordenRonda = [];
    for (let i = 1; i <= gameState.numPlayers; i++) {
      gameState.ordenRonda.push(i);
    }
    shuffle(gameState.ordenRonda);

    gameState.currentPlayer = 1;

    prepareCurrentPlayerScreen();
    showScreen("screen-role");
  }

  // ============================
  // MOSTRAR ROL DEL JUGADOR
  // ============================
  const cardFrontEl    = document.getElementById("cardFront");
  const nextBtnEl      = document.getElementById("nextPlayerBtn");
  const toggleRoleBtn  = document.getElementById("toggleRoleBtn");

  if (isTouch && toggleRoleBtn) {
    toggleRoleBtn.style.display = "none";
  }

  let cardLiftedByButton = false;

  const instructionText = document.getElementById("instructionText");
  if (instructionText) {
    instructionText.innerHTML = isTouch
      ? "Desliza hacia arriba para ver tu rol.<br>Suelta para bajarla."
      : "Haz clic en el botón para ver u ocultar tu rol.";
  }

  function prepareCurrentPlayerScreen() {
    const orderBadge = document.getElementById("playerOrder");
    const roleTitle  = document.getElementById("roleTitle");
    const roleWord   = document.getElementById("roleWord");
    const roleTip    = document.getElementById("roleTip");

    const turnIndex = gameState.currentPlayer;

    const realPlayer =
      gameState.ordenRonda && gameState.ordenRonda.length === gameState.numPlayers
        ? gameState.ordenRonda[turnIndex - 1]
        : turnIndex;

    const idx = realPlayer - 1;

    const isImpostor = realPlayer === gameState.impostorIndex;

    const name =
      gameState.playerNames[idx] ||
      `Jugador ${realPlayer}`;

    const bigNameEl = document.getElementById("playerNameBig");
    if (bigNameEl) {
      bigNameEl.textContent = name;
    }

    const avatarIndex =
      gameState.playerAvatars[idx] ||
      ((idx % MAX_AVATARS) + 1);

    const avatarEl = document.getElementById("frontAvatar");
    if (avatarEl) {
      avatarEl.src = `img/avatar${avatarIndex}.png`;
    }

    if (orderBadge) {
      orderBadge.textContent = `${turnIndex} de ${gameState.numPlayers}`;
    }

    if (isImpostor) {
      roleTitle.textContent = "Impostorcillo";
      roleWord.textContent  = "???";
      roleTip.textContent   =
        "No conoces la palabra secreta. Escucha y finge normalidad.";
    } else {
      roleTitle.textContent = "Ciudadano";
      roleWord.textContent  = `"${gameState.secretWord}"`;
      roleTip.textContent   =
        gameState.secretHint || "Da pistas sin decir la palabra directamente.";
    }

    gameState.roleShown = false;
    nextBtnEl.classList.add("hidden");
    nextBtnEl.classList.remove("active");

    cardFrontEl.style.transform = "translateY(0)";
    cardLiftedByButton = false;
    if (toggleRoleBtn) toggleRoleBtn.textContent = "Mostrar rol";
  }

  // Botón Mostrar / Ocultar rol (para ratón/desktop)
  if (toggleRoleBtn) {
    toggleRoleBtn.addEventListener("click", () => {
      const slider = cardFrontEl.parentElement;
      const h = slider.offsetHeight || 300;

      if (!cardLiftedByButton) {
        cardFrontEl.style.transition = "transform 0.25s ease";
        cardFrontEl.style.transform = `translateY(${-h * 0.7}px)`;

        setTimeout(() => {
          cardFrontEl.style.transition = "";
        }, 260);

        if (!gameState.roleShown) {
          gameState.roleShown = true;
          nextBtnEl.classList.remove("hidden");
          nextBtnEl.classList.add("active");
        }

        toggleRoleBtn.textContent = "Ocultar rol";
        cardLiftedByButton = true;
      } else {
        cardFrontEl.style.transition = "transform 0.25s ease";
        cardFrontEl.style.transform = "translateY(0)";

        setTimeout(() => {
          cardFrontEl.style.transition = "";
        }, 260);

        toggleRoleBtn.textContent = "Mostrar rol";
        cardLiftedByButton = false;
      }
    });
  }

  // ============================
  // SIGUIENTE JUGADOR
  // ============================
  function nextPlayer() {
    nextBtnEl.classList.remove("active");
    nextBtnEl.classList.add("hidden");

    gameState.currentPlayer++;

    if (gameState.currentPlayer > gameState.numPlayers) {
      const starterIndex = gameState.starterPlayer || 1;
      const starterName =
        gameState.playerNames[starterIndex - 1] ||
        `Jugador ${starterIndex}`;
      const starterEl = document.getElementById("starterInfo");
      if (starterEl) {
        starterEl.textContent = `Empieza diciendo su pista: ${starterName}`;
      }

      showScreen("screen-debate");
      return;
    }

    prepareCurrentPlayerScreen();
    showScreen("screen-role");
  }

  // ============================
  // DEBATE Y REVELACIÓN
  // ============================
  function prepareRevealScreen() {
    document.getElementById("finalWord").textContent = gameState.secretWord;

    const impostorName =
      gameState.playerNames[gameState.impostorIndex - 1] ||
      `Jugador ${gameState.impostorIndex}`;

    document.getElementById("impostorPlayer").textContent = impostorName;
  }

  document.getElementById("btnGoReveal").addEventListener("click", () => {
    prepareRevealScreen();
    showScreen("screen-reveal");
  });

  // ============================
  // CARTA DESLIZABLE (TOUCH)
  // ============================
  let dragStartY = 0;
  let dragging   = false;
  let cardHeight = 0;

  function onTouchStart(e) {
    const slider = cardFrontEl.parentElement;
    cardHeight   = slider.offsetHeight || 300;

    dragStartY = e.touches[0].clientY;
    dragging   = true;
    cardFrontEl.style.transition = "none";

    cardLiftedByButton = false;
    if (toggleRoleBtn) toggleRoleBtn.textContent = "Mostrar rol";
  }

  function onTouchMove(e) {
    if (!dragging) return;

    const currentY = e.touches[0].clientY;
    let delta = currentY - dragStartY;

    if (delta > 0) delta = 0;
    if (delta < -cardHeight) delta = -cardHeight;

    cardFrontEl.style.transform = `translateY(${delta}px)`;

    if (delta < -cardHeight / 3 && !gameState.roleShown) {
      gameState.roleShown = true;
      nextBtnEl.classList.remove("hidden");
      nextBtnEl.classList.add("active");
    }
  }

  function onTouchEnd() {
    if (!dragging) return;
    dragging = false;

    cardFrontEl.style.transition = "transform 0.25s ease";
    cardFrontEl.style.transform = "translateY(0)";

    setTimeout(() => {
      cardFrontEl.style.transition = "";
    }, 250);
  }

  cardFrontEl.addEventListener("touchstart", onTouchStart, { passive: true });
  cardFrontEl.addEventListener("touchmove",  onTouchMove,  { passive: true });
  cardFrontEl.addEventListener("touchend",   onTouchEnd);

  // ============================
  // INICIO
  // ============================
  document.getElementById("selectPlayers")
    .addEventListener("change", refreshPlayerNameInputs);

  loadWordsFromCsv();
  refreshPlayerNameInputs();
  showScreen("screen-start");

  const versionEl = document.getElementById("appVersion");
  if (versionEl) {
    versionEl.textContent = "Versión " + APP_VERSION;
  }

  // Exponer funciones globales
  window.startGame = startGame;
  window.nextPlayer = nextPlayer;
  window.startAnotherRound = startAnotherRound;
  window.backToStart = backToStart;
  window.goToSetup = goToSetup;
  </script>

</body>
</html>